<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --accent-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: #f8fafc;
            color: #374151;
        }
        
        /* Navigation */
        .navbar {
            background: var(--primary-gradient);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 1rem 0;
        }
        
        .navbar-brand {
            font-size: 1.8rem;
            font-weight: 800;
            color: white !important;
            text-decoration: none;
        }
        
        .navbar-nav .nav-link {
            color: rgba(255, 255, 255, 0.9) !important;
            font-weight: 500;
            margin: 0 1rem;
            transition: all 0.3s ease;
        }
        
        .navbar-nav .nav-link:hover {
            color: white !important;
            transform: translateY(-2px);
        }
        
        /* Main Content */
        .main-container {
            min-height: calc(100vh - 80px);
            padding: 2rem 0;
        }
        
        .page-header {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .page-title {
            font-size: 2.5rem;
            font-weight: 800;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
        }
        
        .page-subtitle {
            color: #6b7280;
            font-size: 1.1rem;
            margin-bottom: 0;
        }
        
        /* Search and Filter */
        .search-filter-section {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .form-control, .form-select {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn-primary {
            background: var(--primary-gradient);
            border: none;
            border-radius: 12px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        /* Documents Grid */
        .documents-section {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .document-card {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }
        
        .document-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .document-title {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }
        
        .document-meta {
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }
        
        .document-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            border-radius: 8px;
        }
        
        .btn-outline-primary {
            border: 1px solid #667eea;
            color: #667eea;
        }
        
        .btn-outline-primary:hover {
            background: #667eea;
            color: white;
        }
        
        .btn-outline-success {
            border: 1px solid #10b981;
            color: #10b981;
        }
        
        .btn-outline-success:hover {
            background: #10b981;
            color: white;
        }
        
        .btn-outline-danger {
            border: 1px solid #ef4444;
            color: #ef4444;
        }
        
        .btn-outline-danger:hover {
            background: #ef4444;
            color: white;
        }
        
        /* Permission Status */
        .permission-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        
        .permission-owner {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .permission-shared {
            background: #dcfce7;
            color: #166534;
        }
        
        .permission-requested {
            background: #fef3c7;
            color: #92400e;
        }
        
        /* Loading */
        .loading-spinner {
            text-align: center;
            padding: 2rem;
        }
        
        .spinner-border {
            color: #667eea;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .page-title {
                font-size: 2rem;
            }
            
            .main-container {
                padding: 1rem 0;
            }
            
            .page-header, .search-filter-section, .documents-section {
                padding: 1.5rem;
            }
            
            .document-actions {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="/user-dashboard">
                <i class="fas fa-balance-scale me-2"></i>DALI Legal AI
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/user-dashboard">
                            <i class="fas fa-home me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/legal-research">
                            <i class="fas fa-search me-1"></i>Legal Research
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/document-analysis">
                            <i class="fas fa-file-alt me-1"></i>Document Analysis
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/knowledge-base">
                            <i class="fas fa-database me-1"></i>Knowledge Base
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/web-research">
                            <i class="fas fa-globe me-1"></i>Web Research
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/documents">
                            <i class="fas fa-folder me-1"></i>Documents
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/chat">
                            <i class="fas fa-comments me-1"></i>AI Chat
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/logout">
                            <i class="fas fa-sign-out-alt me-1"></i>Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container main-container">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">
                <i class="fas fa-folder me-3"></i>All Documents
            </h1>
            <p class="page-subtitle">
                {{ t('all_documents_subtitle') if t else 'View and manage all documents in your legal knowledge base. Search, filter, and organize your documents.' }}
            </p>
        </div>

        <!-- Search and Filter -->
        <div class="search-filter-section">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="searchInput" class="form-label">
                            <i class="fas fa-search me-2"></i>{{ t('search_documents') if t else 'Search Documents' }}
                        </label>
                        <input type="text" class="form-control" id="searchInput" 
                            placeholder="{{ t('search_placeholder') if t else 'Search by filename, content, or tags...' }}">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label for="typeFilter" class="form-label">
                            <i class="fas fa-filter me-2"></i>{{ t('document_type') if t else 'Document Type' }}
                        </label>
                        <select class="form-select" id="typeFilter">
                            <option value="">{{ t('all_types') if t else 'All Types' }}</option>
                            <option value="pdf">PDF</option>
                            <option value="doc">DOC</option>
                            <option value="docx">DOCX</option>
                            <option value="txt">TXT</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label for="permissionFilter" class="form-label">
                            <i class="fas fa-shield-alt me-2"></i>{{ t('permission') if t else 'Permission' }}
                        </label>
                        <select class="form-select" id="permissionFilter">
                            <option value="">{{ t('all_permissions') if t else 'All Permissions' }}</option>
                            <option value="owner">{{ t('my_documents') if t else 'My Documents' }}</option>
                            <option value="shared">{{ t('shared_with_me') if t else 'Shared with Me' }}</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="text-center">
                <button type="button" class="btn btn-primary" onclick="searchDocuments()">
                    <i class="fas fa-search me-2"></i>{{ t('search') if t else 'Search' }}
                </button>
                <button type="button" class="btn btn-outline-primary ms-2" onclick="clearFilters()">
                    <i class="fas fa-times me-2"></i>{{ t('clear') if t else 'Clear' }}
                </button>
            </div>
        </div>

        <!-- Documents Section -->
        <div class="documents-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3>
                    <i class="fas fa-folder-open me-2"></i>{{ t('documents') if t else 'Documents' }}
                </h3>
                <button type="button" class="btn btn-primary" onclick="refreshDocuments()">
                    <i class="fas fa-sync-alt me-2"></i>{{ t('refresh') if t else 'Refresh' }}
                </button>
            </div>
            
            <div class="loading-spinner" id="loadingSpinner">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">{{ t('loading') if t else 'Loading...' }}</span>
                </div>
                <p class="mt-3">{{ t('loading_documents') if t else 'Loading documents...' }}</p>
            </div>
            
            <div id="documentsList"></div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal fade" id="shareModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-share me-2"></i>{{ t('share_document') if t else 'Share Document' }}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="shareUser" class="form-label">{{ t('select_user') if t else 'Select User' }}</label>
                        <select class="form-select" id="shareUser">
                            <option value="">{{ t('choose_user') if t else 'Choose a user...' }}</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="sharePermission" class="form-label">{{ t('permission_type') if t else 'Permission Type' }}</label>
                        <select class="form-select" id="sharePermission">
                            <option value="read">{{ t('read_only') if t else 'Read Only' }}</option>
                            <option value="write">{{ t('read_write') if t else 'Read & Write' }}</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t('cancel') if t else 'Cancel' }}</button>
                    <button type="button" class="btn btn-primary" onclick="shareDocument()">{{ t('share') if t else 'Share' }}</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentDocumentId = null;
        let allDocuments = [];

        // Load documents on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadDocuments();
            loadUsers();
        });

        async function loadDocuments() {
            try {
                document.getElementById('loadingSpinner').style.display = 'block';
                const response = await fetch('/api/documents');
                const data = await response.json();
                
                if (data.success) {
                    allDocuments = data.documents;
                    displayDocuments(data.documents);
                } else {
                    document.getElementById('documentsList').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            {{ t('error_loading_documents') if t else 'Error loading documents' }}: ${data.error || 'Unknown error'}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading documents:', error);
                document.getElementById('documentsList').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        {{ t('error_loading_documents') if t else 'Error loading documents' }}: ${error.message}
                    </div>
                `;
            } finally {
                document.getElementById('loadingSpinner').style.display = 'none';
            }
        }

        async function loadUsers() {
            try {
                const response = await fetch('/api/users/search');
                const data = await response.json();
                
                if (data.success) {
                    const userSelect = document.getElementById('shareUser');
                    userSelect.innerHTML = '<option value="">{{ t("choose_user") if t else "Choose a user..." }}</option>';
                    
                    data.users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.username;
                        userSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        function displayDocuments(documents) {
            const documentsList = document.getElementById('documentsList');
            
            if (documents.length === 0) {
                documentsList.innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-folder-open fa-3x mb-3"></i>
                        <p>{{ t('no_documents_found') if t else 'No documents found' }}</p>
                    </div>
                `;
                return;
            }

            let html = '';
            documents.forEach(doc => {
                const permissionBadge = getPermissionBadge(doc);
                const fileSize = formatFileSize(doc.file_size || 0);
                const uploadDate = new Date(doc.created_at).toLocaleDateString();
                
                html += `
                    <div class="document-card">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                ${permissionBadge}
                                <div class="document-title">
                                    <i class="fas fa-file-${getFileIcon(doc.title)} me-2"></i>
                                    ${doc.title}
                                </div>
                                <div class="document-meta">
                                    <i class="fas fa-user me-1"></i>${doc.owner_name || 'Unknown'}<br>
                                    <i class="fas fa-calendar me-1"></i>${uploadDate}<br>
                                    <i class="fas fa-tag me-1"></i>${doc.document_type || 'Unknown'}
                                </div>
                            </div>
                            <div class="document-actions">
                                ${getDocumentActions(doc)}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            documentsList.innerHTML = html;
        }

        function getPermissionBadge(doc) {
            if (doc.access_type === 'owner') {
                return `<span class="permission-badge permission-owner">{{ t('owner') if t else 'Owner' }}</span>`;
            } else if (doc.access_type === 'shared') {
                return `<span class="permission-badge permission-shared">{{ t('shared') if t else 'Shared' }}</span>`;
            }
            return '';
        }

        function getFileIcon(filename) {
            if (!filename) return 'alt';
            const ext = filename.split('.').pop().toLowerCase();
            switch (ext) {
                case 'pdf': return 'pdf';
                case 'doc':
                case 'docx': return 'word';
                case 'txt': return 'alt';
                default: return 'alt';
            }
        }

        function getDocumentActions(doc) {
            let actions = '';
            
            if (doc.access_type === 'owner') {
                actions += `
                    <button class="btn btn-sm btn-outline-primary" onclick="viewDocument(${doc.id})">
                        <i class="fas fa-eye me-1"></i>{{ t('view') if t else 'View' }}
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="openShareModal(${doc.id})">
                        <i class="fas fa-share me-1"></i>{{ t('share') if t else 'Share' }}
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteDocument(${doc.id})">
                        <i class="fas fa-trash me-1"></i>{{ t('delete') if t else 'Delete' }}
                    </button>
                `;
            } else if (doc.access_type === 'shared') {
                actions += `
                    <button class="btn btn-sm btn-outline-primary" onclick="viewDocument(${doc.id})">
                        <i class="fas fa-eye me-1"></i>{{ t('view') if t else 'View' }}
                    </button>
                `;
            } else {
                actions += `
                    <button class="btn btn-sm btn-outline-primary" onclick="requestPermission(${doc.id})">
                        <i class="fas fa-hand-paper me-1"></i>{{ t('request_access') if t else 'Request Access' }}
                    </button>
                `;
            }
            
            return actions;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function searchDocuments() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const typeFilter = document.getElementById('typeFilter').value;
            const permissionFilter = document.getElementById('permissionFilter').value;
            
            let filteredDocs = allDocuments.filter(doc => {
                const matchesSearch = !searchTerm || 
                    (doc.title && doc.title.toLowerCase().includes(searchTerm)) ||
                    (doc.content && doc.content.toLowerCase().includes(searchTerm));
                
                const matchesType = !typeFilter || (doc.title && doc.title.toLowerCase().endsWith(typeFilter));
                
                const matchesPermission = !permissionFilter || (
                    (permissionFilter === 'owner' && doc.access_type === 'owner') ||
                    (permissionFilter === 'shared' && doc.access_type === 'shared')
                );
                
                return matchesSearch && matchesType && matchesPermission;
            });
            
            displayDocuments(filteredDocs);
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('permissionFilter').value = '';
            displayDocuments(allDocuments);
        }

        function refreshDocuments() {
            loadDocuments();
        }

        function openShareModal(documentId) {
            currentDocumentId = documentId;
            const modal = new bootstrap.Modal(document.getElementById('shareModal'));
            modal.show();
        }

        async function shareDocument() {
            const userId = document.getElementById('shareUser').value;
            const permissionType = document.getElementById('sharePermission').value;
            
            if (!userId) {
                alert('{{ t("please_select_user") if t else "Please select a user" }}');
                return;
            }
            
            try {
                const response = await fetch(`/api/documents/${currentDocumentId}/share`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: parseInt(userId),
                        permission_type: permissionType
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('{{ t("document_shared_successfully") if t else "Document shared successfully" }}');
                    bootstrap.Modal.getInstance(document.getElementById('shareModal')).hide();
                    loadDocuments(); // Refresh the list
                } else {
                    alert('{{ t("error_sharing_document") if t else "Error sharing document" }}: ' + data.error);
                }
            } catch (error) {
                console.error('Error sharing document:', error);
                alert('{{ t("error_sharing_document") if t else "Error sharing document" }}');
            }
        }

        async function requestPermission(documentId) {
            try {
                const response = await fetch(`/api/documents/${documentId}/request-permission`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('{{ t("permission_requested") if t else "Permission requested successfully" }}');
                    loadDocuments(); // Refresh the list
                } else {
                    alert('{{ t("error_requesting_permission") if t else "Error requesting permission" }}: ' + data.error);
                }
            } catch (error) {
                console.error('Error requesting permission:', error);
                alert('{{ t("error_requesting_permission") if t else "Error requesting permission" }}');
            }
        }

        function viewDocument(documentId) {
            window.open(`/document/${documentId}`, '_blank');
        }

        async function deleteDocument(documentId) {
            if (!confirm('{{ t("confirm_delete_document") if t else "Are you sure you want to delete this document?" }}')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/documents/${documentId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('{{ t("document_deleted_successfully") if t else "Document deleted successfully" }}');
                    loadDocuments(); // Refresh the list
                } else {
                    alert('{{ t("error_deleting_document") if t else "Error deleting document" }}: ' + data.error);
                }
            } catch (error) {
                console.error('Error deleting document:', error);
                alert('{{ t("error_deleting_document") if t else "Error deleting document" }}');
            }
        }
    </script>
</body>
</html>
