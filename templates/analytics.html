<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --accent-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: #f8fafc;
            color: #374151;
        }
        
        /* Navigation */
        .navbar {
            background: var(--primary-gradient);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 1rem 0;
        }
        
        .navbar-brand {
            font-size: 1.8rem;
            font-weight: 800;
            color: white !important;
            text-decoration: none;
        }
        
        .navbar-nav .nav-link {
            color: rgba(255, 255, 255, 0.9) !important;
            font-weight: 500;
            margin: 0 1rem;
            transition: all 0.3s ease;
        }
        
        .navbar-nav .nav-link:hover {
            color: white !important;
            transform: translateY(-2px);
        }
        
        /* Main Content */
        .main-container {
            min-height: calc(100vh - 80px);
            padding: 2rem 0;
        }
        
        .page-header {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .page-title {
            font-size: 2.5rem;
            font-weight: 800;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
        }
        
        .page-subtitle {
            color: #6b7280;
            font-size: 1.1rem;
            margin-bottom: 0;
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            margin-bottom: 1rem;
        }
        
        .stat-icon.primary {
            background: var(--primary-gradient);
        }
        
        .stat-icon.success {
            background: var(--secondary-gradient);
        }
        
        .stat-icon.warning {
            background: var(--accent-gradient);
        }
        
        .stat-icon.danger {
            background: var(--danger-gradient);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: #6b7280;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .stat-change {
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }
        
        .stat-change.positive {
            color: #10b981;
        }
        
        .stat-change.negative {
            color: #ef4444;
        }
        
        /* Charts Section */
        .charts-section {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #374151;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
        }
        
        .section-title i {
            margin-right: 0.75rem;
            color: #667eea;
        }
        
        .chart-container {
            height: 400px;
            margin-bottom: 2rem;
        }
        
        .chart-container:last-child {
            margin-bottom: 0;
        }
        
        /* Activity Feed */
        .activity-feed {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            font-size: 1rem;
            color: white;
        }
        
        .activity-icon.user {
            background: var(--secondary-gradient);
        }
        
        .activity-icon.document {
            background: var(--primary-gradient);
        }
        
        .activity-icon.chat {
            background: var(--accent-gradient);
        }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-text {
            color: #374151;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        
        .activity-time {
            color: #9ca3af;
            font-size: 0.8rem;
        }
        
        /* Filters */
        .filters-section {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .form-control, .form-select {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn-primary {
            background: var(--primary-gradient);
            border: none;
            border-radius: 12px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        /* Loading */
        .loading-spinner {
            text-align: center;
            padding: 2rem;
        }
        
        .spinner-border {
            color: #667eea;
        }
        
        /* Responsive */
        @media (max-width: 768px) {            .main-content-with-sidebar {
                margin-left: 0 !important;
                width: 100% !important;
            }
            
            .sidebar-toggle-mobile {
                display: block;
            }
            
            
            .page-title {
                font-size: 2rem;
            }
            
            .main-container {
                padding: 1rem 0;
            }
            
            .page-header, .charts-section, .activity-feed, .filters-section {
                padding: 1.5rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <!-- Include Sidebar -->
    
    <!-- Main Content with Sidebar -->
    <div class="main-content-with-sidebar">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg">
            <div class="container">
                <div class="navbar-left">
                    <button class="sidebar-toggle-mobile" id="sidebarToggleMobile">
                        <i class="fas fa-bars"></i>
                    </button>
                    <a class="navbar-brand" href="/user-dashboard">
                        <i class="fas fa-balance-scale me-2"></i>DALI Legal AI
                    </a>
                </div>
                
                <div class="navbar-right">
                    <div class="navbar-nav">
                        <div class="nav-item">
                            <a class="nav-link" href="/logout">
                                <i class="fas fa-sign-out-alt me-1"></i>Logout
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

    <!-- Main Content -->
    <div class="container main-container">
        <!-- Back to Dashboard Button -->
        <div class="back-to-dashboard mb-3">
            <a href="/user-dashboard" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
            </a>
        </div>
        
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">
                <i class="fas fa-chart-line me-3"></i>Analytics Dashboard
            </h1>
            <p class="page-subtitle">
                {{ t('analytics_subtitle') if t else 'Comprehensive analytics and insights into system usage, user activity, and performance metrics.' }}
            </p>
        </div>

        <!-- Filters -->
        <div class="filters-section">
            <div class="row">
                <div class="col-md-3">
                    <label for="dateRange" class="form-label">
                        <i class="fas fa-calendar me-2"></i>{{ t('date_range') if t else 'Date Range' }}
                    </label>
                    <select class="form-select" id="dateRange" onchange="updateAnalytics()">
                        <option value="7">{{ t('last_7_days') if t else 'Last 7 Days' }}</option>
                        <option value="30" selected>{{ t('last_30_days') if t else 'Last 30 Days' }}</option>
                        <option value="90">{{ t('last_90_days') if t else 'Last 90 Days' }}</option>
                        <option value="365">{{ t('last_year') if t else 'Last Year' }}</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="userFilter" class="form-label">
                        <i class="fas fa-user me-2"></i>{{ t('user_filter') if t else 'User Filter' }}
                    </label>
                    <select class="form-select" id="userFilter" onchange="updateAnalytics()">
                        <option value="all">{{ t('all_users') if t else 'All Users' }}</option>
                        <option value="active">{{ t('active_users') if t else 'Active Users' }}</option>
                        <option value="admin">{{ t('admin_users') if t else 'Admin Users' }}</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="activityFilter" class="form-label">
                        <i class="fas fa-filter me-2"></i>{{ t('activity_type') if t else 'Activity Type' }}
                    </label>
                    <select class="form-select" id="activityFilter" onchange="updateAnalytics()">
                        <option value="all">{{ t('all_activities') if t else 'All Activities' }}</option>
                        <option value="documents">{{ t('documents') if t else 'Documents' }}</option>
                        <option value="chat">{{ t('chat') if t else 'Chat' }}</option>
                        <option value="research">{{ t('research') if t else 'Research' }}</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-primary w-100" onclick="refreshAnalytics()">
                        <i class="fas fa-sync-alt me-2"></i>{{ t('refresh') if t else 'Refresh' }}
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid" id="statsGrid">
            <div class="loading-spinner">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">{{ t('loading') if t else 'Loading...' }}</span>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section">
            <h3 class="section-title">
                <i class="fas fa-chart-bar"></i>{{ t('usage_analytics') if t else 'Usage Analytics' }}
            </h3>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="chart-container" id="userActivityChart"></div>
                </div>
                <div class="col-md-6">
                    <div class="chart-container" id="documentTypesChart"></div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="chart-container" id="featureUsageChart"></div>
                </div>
                <div class="col-md-6">
                    <div class="chart-container" id="systemPerformanceChart"></div>
                </div>
            </div>
        </div>

        <!-- Activity Feed -->
        <div class="activity-feed">
            <h3 class="section-title">
                <i class="fas fa-history"></i>{{ t('recent_activity') if t else 'Recent Activity' }}
            </h3>
            <div id="activityFeed">
                <div class="loading-spinner">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">{{ t('loading') if t else 'Loading...' }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let analyticsData = {};

        // Load analytics on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadAnalytics();
        });

        async function loadAnalytics() {
            try {
                const dateRange = document.getElementById('dateRange').value;
                const userFilter = document.getElementById('userFilter').value;
                const activityFilter = document.getElementById('activityFilter').value;
                
                const response = await fetch(`/api/analytics?date_range=${dateRange}&user_filter=${userFilter}&activity_filter=${activityFilter}`);
                const data = await response.json();
                
                if (data.success) {
                    analyticsData = data.analytics;
                    displayStats(analyticsData.stats);
                    displayCharts(analyticsData.charts);
                    displayActivityFeed(analyticsData.activity);
                } else {
                    console.error('Error loading analytics:', data.error);
                }
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        function displayStats(stats) {
            const statsGrid = document.getElementById('statsGrid');
            
            const statsHtml = `
                <div class="stat-card">
                    <div class="stat-icon primary">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-value">${stats.total_users}</div>
                    <div class="stat-label">{{ t('total_users') if t else 'Total Users' }}</div>
                    <div class="stat-change positive">+${stats.new_users_this_period} {{ t('this_period') if t else 'this period' }}</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon success">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <div class="stat-value">${stats.total_documents}</div>
                    <div class="stat-label">{{ t('total_documents') if t else 'Total Documents' }}</div>
                    <div class="stat-change positive">+${stats.new_documents_this_period} {{ t('this_period') if t else 'this period' }}</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon warning">
                        <i class="fas fa-comments"></i>
                    </div>
                    <div class="stat-value">${stats.total_messages}</div>
                    <div class="stat-label">{{ t('total_messages') if t else 'Total Messages' }}</div>
                    <div class="stat-change positive">+${stats.new_messages_this_period} {{ t('this_period') if t else 'this period' }}</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon danger">
                        <i class="fas fa-search"></i>
                    </div>
                    <div class="stat-value">${stats.total_researches}</div>
                    <div class="stat-label">{{ t('total_researches') if t else 'Total Researches' }}</div>
                    <div class="stat-change positive">+${stats.new_researches_this_period} {{ t('this_period') if t else 'this period' }}</div>
                </div>
            `;
            
            statsGrid.innerHTML = statsHtml;
        }

        function displayCharts(charts) {
            // User Activity Chart
            Plotly.newPlot('userActivityChart', [{
                x: charts.user_activity.dates,
                y: charts.user_activity.values,
                type: 'scatter',
                mode: 'lines+markers',
                name: '{{ t("daily_active_users") if t else "Daily Active Users" }}',
                line: { color: '#667eea', width: 3 },
                marker: { color: '#667eea', size: 8 }
            }], {
                title: '{{ t("user_activity_over_time") if t else "User Activity Over Time" }}',
                xaxis: { title: '{{ t("date") if t else "Date" }}' },
                yaxis: { title: '{{ t("active_users") if t else "Active Users" }}' },
                margin: { l: 50, r: 50, t: 50, b: 50 }
            });

            // Document Types Chart
            Plotly.newPlot('documentTypesChart', [{
                labels: charts.document_types.labels,
                values: charts.document_types.values,
                type: 'pie',
                marker: {
                    colors: ['#667eea', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
                }
            }], {
                title: '{{ t("document_types_distribution") if t else "Document Types Distribution" }}',
                margin: { l: 50, r: 50, t: 50, b: 50 }
            });

            // Feature Usage Chart
            Plotly.newPlot('featureUsageChart', [{
                x: charts.feature_usage.features,
                y: charts.feature_usage.usage,
                type: 'bar',
                marker: { color: '#10b981' }
            }], {
                title: '{{ t("feature_usage_statistics") if t else "Feature Usage Statistics" }}',
                xaxis: { title: '{{ t("features") if t else "Features" }}' },
                yaxis: { title: '{{ t("usage_count") if t else "Usage Count" }}' },
                margin: { l: 50, r: 50, t: 50, b: 50 }
            });

            // System Performance Chart
            Plotly.newPlot('systemPerformanceChart', [{
                x: charts.system_performance.dates,
                y: charts.system_performance.response_times,
                type: 'scatter',
                mode: 'lines+markers',
                name: '{{ t("response_time_ms") if t else "Response Time (ms)" }}',
                line: { color: '#f59e0b', width: 3 },
                marker: { color: '#f59e0b', size: 8 }
            }], {
                title: '{{ t("system_performance") if t else "System Performance" }}',
                xaxis: { title: '{{ t("date") if t else "Date" }}' },
                yaxis: { title: '{{ t("response_time_ms") if t else "Response Time (ms)" }}' },
                margin: { l: 50, r: 50, t: 50, b: 50 }
            });
        }

        function displayActivityFeed(activities) {
            const activityFeed = document.getElementById('activityFeed');
            
            if (activities.length === 0) {
                activityFeed.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-history fa-2x mb-3"></i>
                        <p>{{ t('no_recent_activity') if t else 'No recent activity' }}</p>
                    </div>
                `;
                return;
            }

            let html = '';
            activities.forEach(activity => {
                const iconClass = getActivityIcon(activity.type);
                const timeAgo = formatTimeAgo(activity.timestamp);
                
                html += `
                    <div class="activity-item">
                        <div class="activity-icon ${iconClass.class}">
                            <i class="${iconClass.icon}"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-text">${activity.description}</div>
                            <div class="activity-time">${timeAgo}</div>
                        </div>
                    </div>
                `;
            });
            
            activityFeed.innerHTML = html;
        }

        function getActivityIcon(type) {
            switch (type) {
                case 'user':
                    return { class: 'user', icon: 'fas fa-user' };
                case 'document':
                    return { class: 'document', icon: 'fas fa-file-alt' };
                case 'chat':
                    return { class: 'chat', icon: 'fas fa-comments' };
                default:
                    return { class: 'user', icon: 'fas fa-circle' };
            }
        }

        function formatTimeAgo(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diffInSeconds = Math.floor((now - time) / 1000);
            
            if (diffInSeconds < 60) return '{{ t("just_now") if t else "Just now" }}';
            if (diffInSeconds < 3600) return Math.floor(diffInSeconds / 60) + ' {{ t("minutes_ago") if t else "minutes ago" }}';
            if (diffInSeconds < 86400) return Math.floor(diffInSeconds / 3600) + ' {{ t("hours_ago") if t else "hours ago" }}';
            return Math.floor(diffInSeconds / 86400) + ' {{ t("days_ago") if t else "days ago" }}';
        }

        function updateAnalytics() {
            loadAnalytics();
        }

        function refreshAnalytics() {
            loadAnalytics();
        }
    </script>
    </div>
</body>
</html>
