<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --accent-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: #f8fafc;
            color: #374151;
        }
        
        /* Navigation */
        .navbar {
            background: var(--primary-gradient);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 1rem 0;
        }
        
        .navbar-brand {
            font-size: 1.8rem;
            font-weight: 800;
            color: white !important;
            text-decoration: none;
        }
        
        .navbar-nav .nav-link {
            color: rgba(255, 255, 255, 0.9) !important;
            font-weight: 500;
            margin: 0 1rem;
            transition: all 0.3s ease;
        }
        
        .navbar-nav .nav-link:hover {
            color: white !important;
            transform: translateY(-2px);
        }
        
        /* Main Content */
        .main-container {
            min-height: calc(100vh - 80px);
            padding: 2rem 0;
        }
        
        .document-header {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .document-title {
            font-size: 2rem;
            font-weight: 700;
            color: #374151;
            margin-bottom: 1rem;
        }
        
        .document-meta {
            color: #6b7280;
            font-size: 1rem;
        }
        
        .document-meta i {
            margin-right: 0.5rem;
            width: 16px;
        }
        
        /* Document Content */
        .document-content {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .content-text {
            line-height: 1.8;
            color: #374151;
            font-size: 1rem;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        /* Actions */
        .document-actions {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .btn-primary {
            background: var(--primary-gradient);
            border: none;
            border-radius: 12px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-outline-primary {
            border: 1px solid #667eea;
            color: #667eea;
            border-radius: 12px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-outline-primary:hover {
            background: #667eea;
            color: white;
        }
        
        .btn-outline-success {
            border: 1px solid #10b981;
            color: #10b981;
            border-radius: 12px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-outline-success:hover {
            background: #10b981;
            color: white;
        }
        
        .btn-outline-danger {
            border: 1px solid #ef4444;
            color: #ef4444;
            border-radius: 12px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-outline-danger:hover {
            background: #ef4444;
            color: white;
        }
        
        /* Permission Status */
        .permission-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 1rem;
        }
        
        .permission-owner {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .permission-shared {
            background: #dcfce7;
            color: #166534;
        }
        
        .permission-requested {
            background: #fef3c7;
            color: #92400e;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .document-title {
                font-size: 1.5rem;
            }
            
            .main-container {
                padding: 1rem 0;
            }
            
            .document-header, .document-content, .document-actions {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="/user-dashboard">
                <i class="fas fa-balance-scale me-2"></i>DALI Legal AI
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/user-dashboard">
                            <i class="fas fa-home me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/legal-research">
                            <i class="fas fa-search me-1"></i>Legal Research
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/document-analysis">
                            <i class="fas fa-file-alt me-1"></i>Document Analysis
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/knowledge-base">
                            <i class="fas fa-database me-1"></i>Knowledge Base
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/web-research">
                            <i class="fas fa-globe me-1"></i>Web Research
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/all-documents">
                            <i class="fas fa-folder me-1"></i>Documents
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/chat">
                            <i class="fas fa-comments me-1"></i>AI Chat
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/logout">
                            <i class="fas fa-sign-out-alt me-1"></i>Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container main-container">
        <!-- Document Header -->
        <div class="document-header">
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    {% if document.is_owner %}
                        <span class="permission-badge permission-owner">{{ t('owner') if t else 'Owner' }}</span>
                    {% elif document.permission_type %}
                        <span class="permission-badge permission-shared">{{ t('shared') if t else 'Shared' }}</span>
                    {% endif %}
                    
                    <h1 class="document-title">
                        <i class="fas fa-file-{{ 'pdf' if document.title.endswith('.pdf') else 'word' if document.title.endswith(('.doc', '.docx')) else 'alt' }} me-3"></i>
                        {{ document.title }}
                    </h1>
                    
                    <div class="document-meta">
                        <div class="row">
                            <div class="col-md-6">
                                <p><i class="fas fa-user"></i>{{ t('uploaded_by') if t else 'Uploaded by' }}: <strong>{{ document.uploader_name or 'Unknown' }}</strong></p>
                                <p><i class="fas fa-calendar"></i>{{ t('upload_date') if t else 'Upload Date' }}: <strong>{{ document.created_at[:10] if document.created_at else 'Unknown' }}</strong></p>
                            </div>
                            <div class="col-md-6">
                                <p><i class="fas fa-weight"></i>{{ t('file_size') if t else 'File Size' }}: <strong>{{ "%.2f KB"|format(document.content|length / 1024) if document.content else 'Unknown' }}</strong></p>
                                <p><i class="fas fa-tag"></i>{{ t('file_type') if t else 'File Type' }}: <strong>{{ document.title.split('.')[-1].upper() if '.' in document.title else 'Unknown' }}</strong></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Document Content -->
        <div class="document-content">
            <h3 class="mb-4">
                <i class="fas fa-file-text me-2"></i>{{ t('document_content') if t else 'Document Content' }}
            </h3>
            <div class="content-text">{{ document.content or (t('no_content_available') if t else 'No content available for this document.') }}</div>
        </div>

        <!-- Document Actions -->
        <div class="document-actions">
            <h4 class="mb-3">
                <i class="fas fa-cogs me-2"></i>{{ t('actions') if t else 'Actions' }}
            </h4>
            <div class="d-flex gap-3 flex-wrap">
                {% if document.is_owner %}
                    <button class="btn btn-outline-primary" onclick="shareDocument()">
                        <i class="fas fa-share me-2"></i>{{ t('share_document') if t else 'Share Document' }}
                    </button>
                    <button class="btn btn-outline-success" onclick="downloadDocument()">
                        <i class="fas fa-download me-2"></i>{{ t('download') if t else 'Download' }}
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteDocument()">
                        <i class="fas fa-trash me-2"></i>{{ t('delete') if t else 'Delete' }}
                    </button>
                {% elif document.permission_type %}
                    <button class="btn btn-outline-success" onclick="downloadDocument()">
                        <i class="fas fa-download me-2"></i>{{ t('download') if t else 'Download' }}
                    </button>
                {% else %}
                    <button class="btn btn-outline-primary" onclick="requestPermission()">
                        <i class="fas fa-hand-paper me-2"></i>{{ t('request_access') if t else 'Request Access' }}
                    </button>
                {% endif %}
                
                <button class="btn btn-primary" onclick="analyzeDocument()">
                    <i class="fas fa-analytics me-2"></i>{{ t('analyze_document') if t else 'Analyze Document' }}
                </button>
                
                <a href="/all-documents" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>{{ t('back_to_documents') if t else 'Back to Documents' }}
                </a>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal fade" id="shareModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-share me-2"></i>{{ t('share_document') if t else 'Share Document' }}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="shareUser" class="form-label">{{ t('select_user') if t else 'Select User' }}</label>
                        <select class="form-select" id="shareUser">
                            <option value="">{{ t('choose_user') if t else 'Choose a user...' }}</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="sharePermission" class="form-label">{{ t('permission_type') if t else 'Permission Type' }}</label>
                        <select class="form-select" id="sharePermission">
                            <option value="read">{{ t('read_only') if t else 'Read Only' }}</option>
                            <option value="write">{{ t('read_write') if t else 'Read & Write' }}</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t('cancel') if t else 'Cancel' }}</button>
                    <button type="button" class="btn btn-primary" onclick="shareDocumentConfirm()">{{ t('share') if t else 'Share' }}</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const documentId = {{ document.id }};
        const isOwner = {{ 'true' if document.is_owner else 'false' }};

        // Load users for sharing
        document.addEventListener('DOMContentLoaded', function() {
            loadUsers();
        });

        async function loadUsers() {
            try {
                const response = await fetch('/api/users/search');
                const data = await response.json();
                
                if (data.success) {
                    const userSelect = document.getElementById('shareUser');
                    userSelect.innerHTML = '<option value="">{{ t("choose_user") if t else "Choose a user..." }}</option>';
                    
                    data.users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.username;
                        userSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        function shareDocument() {
            if (!isOwner) {
                alert('{{ t("only_owner_can_share") if t else "Only the document owner can share this document" }}');
                return;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('shareModal'));
            modal.show();
        }

        async function shareDocumentConfirm() {
            const userId = document.getElementById('shareUser').value;
            const permissionType = document.getElementById('sharePermission').value;
            
            if (!userId) {
                alert('{{ t("please_select_user") if t else "Please select a user" }}');
                return;
            }
            
            try {
                const response = await fetch(`/api/documents/${documentId}/share`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: parseInt(userId),
                        permission_type: permissionType
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('{{ t("document_shared_successfully") if t else "Document shared successfully" }}');
                    bootstrap.Modal.getInstance(document.getElementById('shareModal')).hide();
                } else {
                    alert('{{ t("error_sharing_document") if t else "Error sharing document" }}: ' + data.error);
                }
            } catch (error) {
                console.error('Error sharing document:', error);
                alert('{{ t("error_sharing_document") if t else "Error sharing document" }}');
            }
        }

        async function requestPermission() {
            try {
                const response = await fetch(`/api/documents/${documentId}/request-permission`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('{{ t("permission_requested") if t else "Permission requested successfully" }}');
                    location.reload(); // Refresh to show updated status
                } else {
                    alert('{{ t("error_requesting_permission") if t else "Error requesting permission" }}: ' + data.error);
                }
            } catch (error) {
                console.error('Error requesting permission:', error);
                alert('{{ t("error_requesting_permission") if t else "Error requesting permission" }}');
            }
        }

        function downloadDocument() {
            window.open(`/api/documents/${documentId}/download`, '_blank');
        }

        async function deleteDocument() {
            if (!isOwner) {
                alert('{{ t("only_owner_can_delete") if t else "Only the document owner can delete this document" }}');
                return;
            }
            
            if (!confirm('{{ t("confirm_delete_document") if t else "Are you sure you want to delete this document? This action cannot be undone." }}')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/documents/${documentId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('{{ t("document_deleted_successfully") if t else "Document deleted successfully" }}');
                    window.location.href = '/all-documents';
                } else {
                    alert('{{ t("error_deleting_document") if t else "Error deleting document" }}: ' + data.error);
                }
            } catch (error) {
                console.error('Error deleting document:', error);
                alert('{{ t("error_deleting_document") if t else "Error deleting document" }}');
            }
        }

        function analyzeDocument() {
            // Redirect to document analysis page with this document
            window.location.href = `/document-analysis?document_id=${documentId}`;
        }
    </script>
</body>
</html>
