{% extends "chatgpt_base.html" %}
{% block title %}{{ t('knowledge_base') if t else 'Knowledge Base' }} - DALI Legal AI{% endblock %}

{% block head %}
<link rel="stylesheet" href="/static/chatgpt-ui.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="chatgpt-layout">
    <!-- ChatGPT-Style Sidebar -->
    <aside class="chatgpt-sidebar" id="sidebar">
        <div class="chatgpt-sidebar-header">
            <div class="chatgpt-sidebar-title">⚖️ DALI Legal AI</div>
            <div class="chatgpt-sidebar-subtitle">{{ t('welcome_subtitle') if t else 'Your intelligent legal assistant' }}</div>
        </div>
        
        <button class="chatgpt-new-chat-btn" onclick="startNewSearch()">
            <span>+</span>
            {{ t('new_search') if t else 'New Search' }}
        </button>
        
        <nav class="chatgpt-nav">
            <div class="chatgpt-nav-section">
                <div class="chatgpt-nav-section-title">{{ t('legal_tools') if t else 'Legal Tools' }}</div>
                <div class="chatgpt-nav-item">
                    <a href="/dashboard" class="chatgpt-nav-link">
                        <span class="chatgpt-nav-icon">🏠</span>
                        {{ t('dashboard') if t else 'Dashboard' }}
                    </a>
                </div>
                <div class="chatgpt-nav-item">
                    <a href="/legal-research" class="chatgpt-nav-link">
                        <span class="chatgpt-nav-icon">🔍</span>
                        {{ t('legal_research') if t else 'Legal Research' }}
                    </a>
                </div>
                <div class="chatgpt-nav-item">
                    <a href="/document-analysis" class="chatgpt-nav-link">
                        <span class="chatgpt-nav-icon">📄</span>
                        {{ t('document_analysis') if t else 'Document Analysis' }}
                    </a>
                </div>
                <div class="chatgpt-nav-item">
                    <a href="/knowledge-base" class="chatgpt-nav-link active">
                        <span class="chatgpt-nav-icon">📚</span>
                        {{ t('knowledge_base') if t else 'Knowledge Base' }}
                    </a>
                </div>
                <div class="chatgpt-nav-item">
                    <a href="/web-research" class="chatgpt-nav-link">
                        <span class="chatgpt-nav-icon">🌐</span>
                        {{ t('web_research') if t else 'Web Research' }}
                    </a>
                </div>
            </div>
            
            <div class="chatgpt-nav-section">
                <div class="chatgpt-nav-section-title">{{ t('account') if t else 'Account' }}</div>
                <div class="chatgpt-nav-item">
                    <a href="/settings" class="chatgpt-nav-link">
                        <span class="chatgpt-nav-icon">⚙️</span>
                        {{ t('settings') if t else 'Settings' }}
                    </a>
                </div>
                {% if user and user.role == 'admin' %}
                <div class="chatgpt-nav-item">
                    <a href="/admin/dashboard" class="chatgpt-nav-link">
                        <span class="chatgpt-nav-icon">👑</span>
                        {{ t('admin_panel') if t else 'Admin Panel' }}
                    </a>
                </div>
                {% endif %}
            </div>
        </nav>
        
        {% if user %}
        <div class="chatgpt-user-info">
            <div class="chatgpt-user-greeting">{{ t('hello') if t else 'Hello' }}, {{ user.greeting_name or user.username }}</div>
            <div class="chatgpt-user-role">{{ t('role_' + user.role) if t else user.role.title() }}</div>
            <form method="get" action="/logout">
                <button type="submit" class="chatgpt-logout-btn">
                    {{ t('logout') if t else 'Logout' }}
                </button>
            </form>
        </div>
        {% endif %}
    </aside>
    
    <!-- Main Knowledge Base Interface -->
    <main class="chatgpt-main">
        <!-- Mobile Menu Button -->
        <button class="chatgpt-mobile-menu" onclick="toggleSidebar()">
            ☰
        </button>
        
        <!-- Knowledge Base Header -->
        <div class="chatgpt-header">
            <div class="chatgpt-header-title">{{ t('knowledge_base') if t else 'Knowledge Base' }}</div>
            <div class="chatgpt-header-subtitle">{{ t('knowledge_base_subtitle') if t else 'Search and manage your legal documents and knowledge' }}</div>
        </div>
        
        <!-- Welcome Screen -->
        <div class="chatgpt-welcome" id="welcomeScreen">
            <div class="chatgpt-welcome-icon">📚</div>
            <h1 class="chatgpt-welcome-title">{{ t('knowledge_base') if t else 'Knowledge Base' }}</h1>
            <p class="chatgpt-welcome-subtitle">{{ t('knowledge_base_description') if t else 'Search through your uploaded documents, legal precedents, and knowledge base. Find relevant information quickly and efficiently.' }}</p>
            
            <div class="chatgpt-welcome-actions">
                <button class="chatgpt-action-btn" onclick="searchDocuments()">
                    🔍 {{ t('search_documents') if t else 'Search Documents' }}
                </button>
                <button class="chatgpt-action-btn" onclick="viewAllDocuments()">
                    📄 {{ t('view_all_documents') if t else 'View All Documents' }}
                </button>
                <button class="chatgpt-action-btn" onclick="uploadNewDocument()">
                    📤 {{ t('upload_document') if t else 'Upload Document' }}
                </button>
                <button class="chatgpt-action-btn" onclick="manageCategories()">
                    📁 {{ t('manage_categories') if t else 'Manage Categories' }}
                </button>
            </div>
        </div>
        
        <!-- Search Interface -->
        <div class="chatgpt-messages" id="searchInterface" style="display: none;">
            <div class="chatgpt-card">
                <div class="chatgpt-card-header">
                    <div class="chatgpt-card-title">{{ t('search_knowledge_base') if t else 'Search Knowledge Base' }}</div>
                    <div class="chatgpt-card-subtitle">{{ t('search_subtitle') if t else 'Find relevant documents and information' }}</div>
                </div>
                
                <form id="searchForm">
                    <div class="chatgpt-form-group">
                        <label class="chatgpt-form-label">{{ t('search_query') if t else 'Search Query' }}</label>
                        <input type="text" class="chatgpt-form-input" id="searchQuery" placeholder="{{ t('enter_search_terms') if t else 'Enter search terms...' }}" required>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--chatgpt-spacing-lg);">
                        <div class="chatgpt-form-group">
                            <label class="chatgpt-form-label">{{ t('number_of_results') if t else 'Number of Results' }}</label>
                            <select class="chatgpt-form-input" id="numResults">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="20">20</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                        
                        <div class="chatgpt-form-group">
                            <label class="chatgpt-form-label">{{ t('minimum_score') if t else 'Minimum Score' }}</label>
                            <select class="chatgpt-form-input" id="minScore">
                                <option value="0.1">0.1</option>
                                <option value="0.3" selected>0.3</option>
                                <option value="0.5">0.5</option>
                                <option value="0.7">0.7</option>
                            </select>
                        </div>
                    </div>
                    
                    <button type="submit" class="chatgpt-btn chatgpt-btn-primary" style="width: 100%;">
                        🔍 {{ t('search') if t else 'Search' }}
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Search Result Display (for form submissions) -->
        <!-- AI Analysis Display (for search results) -->
        {% if ai_analysis %}
        <div class="chatgpt-research-result" id="aiAnalysis">
            <div class="chatgpt-research-header">
                <h2>{{ t('ai_analysis') if t else 'AI Analysis' }}</h2>
                <p class="chatgpt-research-query">{{ t('analysis_for_query') if t else 'Analysis for' }}: {{ search_query }}</p>
            </div>
            <div class="chatgpt-research-content">
                <div class="legal-research-result">{{ ai_analysis }}</div>
            </div>
        </div>
        {% endif %}
        
        <!-- Search Results Display (for form submissions) -->
        {% if results %}
        <div class="chatgpt-research-result" id="searchResult">
            <div class="chatgpt-research-header">
                <h2>{{ t('search_results') if t else 'Search Results' }}</h2>
                <p class="chatgpt-research-query">{{ t('query') if t else 'Query' }}: {{ search_query }}</p>
            </div>
            <div class="chatgpt-research-content">
                <div class="legal-research-result">
                    {% for result in results %}
                    <div class="search-result-item">
                        <h4>{{ result.title or result.metadata.title if result.metadata else 'Document' }}</h4>
                        <p><strong>Score:</strong> {{ "%.2f"|format(result.score) if result.score else 'N/A' }}</p>
                        <p><strong>Content:</strong> {{ result.content[:500] }}{% if result.content|length > 500 %}...{% endif %}</p>
                        {% if result.metadata %}
                        <p><strong>Type:</strong> {{ result.metadata.type or 'Unknown' }}</p>
                        <p><strong>Source:</strong> {{ result.metadata.source or 'Unknown' }}</p>
                        {% endif %}
                        <hr>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Chat Messages Area -->
        <div class="chatgpt-messages" id="chatMessages" style="display: none;">
            <!-- Messages will be dynamically added here -->
        </div>
        
        <!-- Document Management -->
        <div class="chatgpt-messages" id="documentManagement" style="display: none;">
            <div class="chatgpt-card">
                <div class="chatgpt-card-header">
                    <div class="chatgpt-card-title">{{ t('document_management') if t else 'Document Management' }}</div>
                    <div class="chatgpt-card-subtitle">{{ t('manage_your_documents') if t else 'Manage your uploaded documents' }}</div>
                </div>
                
                <div id="documentList">
                    <!-- Documents will be loaded here -->
                </div>
            </div>
        </div>
        
        <!-- Input Area -->
        <div class="chatgpt-input-area">
            <div class="chatgpt-input-container">
                <textarea 
                    class="chatgpt-input" 
                    id="chatInput" 
                    placeholder="{{ t('ask_about_knowledge') if t else 'Ask questions about your knowledge base...' }}"
                    rows="1"
                    onkeydown="handleKeyDown(event)"
                    oninput="autoResize(this)"
                ></textarea>
                <button class="chatgpt-send-btn" id="sendBtn" onclick="sendMessage()">
                    ➤
                </button>
            </div>
        </div>
    </main>
</div>

<script>
let currentSearchId = null;
let isSearching = false;

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('open');
}

function startNewSearch() {
    currentSearchId = null;
    document.getElementById('welcomeScreen').style.display = 'flex';
    document.getElementById('searchInterface').style.display = 'none';
    document.getElementById('searchResults').style.display = 'none';
    document.getElementById('documentManagement').style.display = 'none';
    document.getElementById('chatInput').value = '';
}

function searchDocuments() {
    document.getElementById('welcomeScreen').style.display = 'none';
    document.getElementById('searchInterface').style.display = 'flex';
    document.getElementById('searchResults').style.display = 'none';
    document.getElementById('documentManagement').style.display = 'none';
}

function viewAllDocuments() {
    document.getElementById('welcomeScreen').style.display = 'none';
    document.getElementById('searchInterface').style.display = 'none';
    document.getElementById('searchResults').style.display = 'none';
    document.getElementById('documentManagement').style.display = 'flex';
    loadDocuments();
}

function uploadNewDocument() {
    window.location.href = '/document-analysis';
}

function manageCategories() {
    alert('Category management feature coming soon!');
}

function autoResize(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
}

function handleKeyDown(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
    }
}

function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message || isSearching) return;
    
    // Add user message
    addMessage('user', message);
    
    // Clear input
    input.value = '';
    input.style.height = 'auto';
    
    // Show typing indicator
    showTypingIndicator();
    
    // Send to knowledge base search
    const formData = new FormData();
    formData.append('search_query', message);
    formData.append('num_results', '5');
    formData.append('min_score', '0.3');
    
    fetch('/knowledge-base', {
        method: 'POST',
        body: formData
    })
    .then(response => response.text())
    .then(html => {
        hideTypingIndicator();
        // Extract the search results from the response
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        let answer = 'I found some relevant information in your knowledge base.';
        
        // Look for search results in various possible locations
        const resultSelectors = [
            '.search-results',
            '.results',
            '.knowledge-base-results',
            '.document-results',
            'table',
            '.content'
        ];
        
        for (const selector of resultSelectors) {
            const element = doc.querySelector(selector);
            if (element && element.textContent.trim()) {
                const text = element.textContent.trim();
                if (text.length > 50) {
                    answer = text;
                    break;
                }
            }
        }
        
        // If no specific results found, look for any meaningful content
        if (answer === 'I found some relevant information in your knowledge base.') {
            const bodyText = doc.body.textContent.trim();
            if (bodyText && bodyText.length > 50) {
                // Extract meaningful content (skip navigation, headers, etc.)
                const lines = bodyText.split('\n').filter(line => 
                    line.trim().length > 20 && 
                    !line.includes('DALI') && 
                    !line.includes('Navigation') &&
                    !line.includes('Settings') &&
                    !line.includes('Knowledge Base')
                );
                if (lines.length > 0) {
                    answer = lines.slice(0, 3).join('\n').trim(); // Take first 3 meaningful lines
                }
            }
        }
        
        addMessage('assistant', answer);
    })
    .catch(error => {
        hideTypingIndicator();
        addMessage('assistant', 'I apologize, but I encountered an error while searching your knowledge base. Please try again.');
        console.error('Error:', error);
    });
}

function formatMessage(text) {
    // Convert the text to HTML with proper formatting
    let formatted = text
        // Convert numbered lists (1. **text**: description)
        .replace(/(\d+)\.\s*\*\*(.*?)\*\*:\s*(.*?)(?=\d+\.\s*\*\*|$)/gs, (match, num, title, desc) => {
            return `<div class="chatgpt-list-item">
                <div class="chatgpt-list-number">${num}.</div>
                <div class="chatgpt-list-content">
                    <div class="chatgpt-list-title">${title}</div>
                    <div class="chatgpt-list-description">${desc.trim()}</div>
                </div>
            </div>`;
        })
        // Convert bold text **text** to <strong>text</strong>
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        // Convert line breaks to <br>
        .replace(/\n/g, '<br>')
        // Convert double line breaks to paragraph breaks
        .replace(/(<br>\s*){2,}/g, '</p><p>')
        // Wrap in paragraph tags
        .replace(/^(.*)$/, '<p>$1</p>')
        // Clean up empty paragraphs
        .replace(/<p><\/p>/g, '')
        .replace(/<p><br><\/p>/g, '');
    
    return formatted;
}

function addMessage(sender, text) {
        const messagesContainer = document.getElementById('chatMessages');
    if (messagesContainer.style.display === 'none') {
        messagesContainer.style.display = 'flex';
        document.getElementById('welcomeScreen').style.display = 'none';
        document.getElementById('searchInterface').style.display = 'none';
        document.getElementById('documentManagement').style.display = 'none';
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'chatgpt-message';
    
    const avatar = document.createElement('div');
    avatar.className = `chatgpt-message-avatar ${sender}`;
    avatar.textContent = sender === 'user' ? 'U' : 'AI';
    
    const content = document.createElement('div');
    content.className = 'chatgpt-message-content';
    
    const textDiv = document.createElement('div');
    textDiv.className = 'chatgpt-message-text';
    
    if (sender === 'assistant') {
        // Format AI responses with proper HTML
        textDiv.innerHTML = formatMessage(text);
    } else {
        // Keep user messages as plain text
        textDiv.textContent = text;
    }
    
    const metaDiv = document.createElement('div');
    metaDiv.className = 'chatgpt-message-meta';
    metaDiv.textContent = new Date().toLocaleTimeString();
    
    content.appendChild(textDiv);
    content.appendChild(metaDiv);
    
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(content);
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function showTypingIndicator() {
    isSearching = true;
        const messagesContainer = document.getElementById('chatMessages');
    if (messagesContainer.style.display === 'none') {
        messagesContainer.style.display = 'flex';
        document.getElementById('welcomeScreen').style.display = 'none';
        document.getElementById('searchInterface').style.display = 'none';
        document.getElementById('documentManagement').style.display = 'none';
    }
    
    const typingDiv = document.createElement('div');
    typingDiv.className = 'chatgpt-message';
    typingDiv.id = 'typingIndicator';
    
    const avatar = document.createElement('div');
    avatar.className = 'chatgpt-message-avatar assistant';
    avatar.textContent = 'AI';
    
    const content = document.createElement('div');
    content.className = 'chatgpt-message-content';
    
    const typingContent = document.createElement('div');
    typingContent.className = 'chatgpt-typing';
    typingContent.innerHTML = `
        <span>AI is searching...</span>
        <div class="chatgpt-typing-dots">
            <div class="chatgpt-typing-dot"></div>
            <div class="chatgpt-typing-dot"></div>
            <div class="chatgpt-typing-dot"></div>
        </div>
    `;
    
    content.appendChild(typingContent);
    
    typingDiv.appendChild(avatar);
    typingDiv.appendChild(content);
    
    messagesContainer.appendChild(typingDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function hideTypingIndicator() {
    isSearching = false;
    const typingIndicator = document.getElementById('typingIndicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

function loadDocuments() {
    // Load documents from the knowledge base
    fetch('/knowledge-base')
    .then(response => response.text())
    .then(html => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const documentsElement = doc.querySelector('.documents-table');
        if (documentsElement) {
            document.getElementById('documentList').innerHTML = documentsElement.outerHTML;
        } else {
            document.getElementById('documentList').innerHTML = '<p>No documents found in your knowledge base.</p>';
        }
    })
    .catch(error => {
        console.error('Error loading documents:', error);
        document.getElementById('documentList').innerHTML = '<p>Error loading documents. Please try again.</p>';
    });
}

// Search form handling
document.getElementById('searchForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const searchQuery = document.getElementById('searchQuery').value;
    const numResults = document.getElementById('numResults').value;
    const minScore = document.getElementById('minScore').value;
    
    if (!searchQuery.trim()) {
        alert('Please enter a search query.');
        return;
    }
    
    const formData = new FormData();
    formData.append('search_query', searchQuery);
    formData.append('num_results', numResults);
    formData.append('min_score', minScore);
    
    // Show searching indicator
    showTypingIndicator();
    
    fetch('/knowledge-base', {
        method: 'POST',
        body: formData
    })
    .then(response => response.text())
    .then(html => {
        hideTypingIndicator();
        // Extract the search results from the response
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const resultsElement = doc.querySelector('.search-results');
        const results = resultsElement ? resultsElement.textContent.trim() : 'Search completed. Results will be displayed here.';
        
        document.getElementById('searchInterface').style.display = 'none';
        document.getElementById('chatMessages').style.display = 'flex';
        addMessage('assistant', results);
    })
    .catch(error => {
        hideTypingIndicator();
        alert('Error searching knowledge base. Please try again.');
        console.error('Error:', error);
    });
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('chatInput').focus();
    
    // Close sidebar on mobile when clicking outside
    document.addEventListener('click', function(event) {
        const sidebar = document.getElementById('sidebar');
        const mobileMenu = document.querySelector('.chatgpt-mobile-menu');
        
        if (window.innerWidth <= 768 && 
            !sidebar.contains(event.target) && 
            !mobileMenu.contains(event.target)) {
            sidebar.classList.remove('open');
        }
    });
});
</script>
{% endblock %}
