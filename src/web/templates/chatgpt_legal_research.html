{% extends "chatgpt_base.html" %}
{% block title %}Legal Research - DALI Legal AI{% endblock %}

{% block head %}
<link rel="stylesheet" href="/static/chatgpt-ui.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
/* Legal Research Styles */
.legal-research-page {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
    background: #f8fafc;
    min-height: 100vh;
}

.page-header {
    text-align: center;
    margin-bottom: 40px;
    padding: 30px;
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

.page-title {
    font-size: 2.5rem;
    font-weight: 700;
    color: #1f2937;
    margin: 0 0 15px 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.page-subtitle {
    font-size: 1.1rem;
    color: #6b7280;
    margin: 0;
    max-width: 600px;
    margin: 0 auto;
}

.research-container {
    background: white;
    border-radius: 16px;
    padding: 40px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

.form-group {
    margin-bottom: 25px;
}

.form-label {
    display: block;
    font-weight: 600;
    color: #374151;
    margin-bottom: 10px;
    font-size: 1rem;
}

.form-input, .form-textarea, .form-select {
    width: 100%;
    padding: 15px 20px;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: #f9fafb;
    color: #374151;
    font-family: inherit;
}

.form-input:focus, .form-textarea:focus, .form-select:focus {
    outline: none;
    border-color: #667eea;
    background: white;
    box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
}

.form-textarea {
    resize: vertical;
    min-height: 120px;
    line-height: 1.6;
}

.checkbox-container {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 15px;
}

.checkbox-container input[type="checkbox"] {
    width: 20px;
    height: 20px;
    accent-color: #667eea;
}

.checkbox-container label {
    font-weight: 500;
    color: #374151;
    cursor: pointer;
}

.submit-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 18px 40px;
    border-radius: 12px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    width: 100%;
    margin-top: 10px;
}

.submit-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

.submit-btn:disabled {
    background: #9ca3af;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.results-container {
    background: white;
    border-radius: 16px;
    padding: 40px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    margin-bottom: 30px;
    display: none;
}

.results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid #f3f4f6;
}

.results-title {
    font-size: 1.8rem;
    font-weight: 700;
    color: #1f2937;
    margin: 0;
}

.results-actions {
    display: flex;
    gap: 15px;
}

.action-btn {
    padding: 12px 24px;
    background: #f3f4f6;
    color: #374151;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.action-btn:hover {
    background: #e5e7eb;
    color: #1f2937;
    transform: translateY(-1px);
}

.action-btn.primary {
    background: #667eea;
    color: white;
    border-color: #667eea;
}

.action-btn.primary:hover {
    background: #5a67d8;
    color: white;
}

.result-content {
    background: #f8fafc;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 30px;
    margin-bottom: 20px;
    line-height: 1.7;
    font-size: 1rem;
    color: #374151;
    white-space: pre-wrap;
}

.result-actions {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
}

.message-container {
    margin-bottom: 20px;
}

.success-message {
    background: #d1fae5;
    color: #065f46;
    padding: 20px;
    border-radius: 12px;
    border: 1px solid #a7f3d0;
    font-weight: 500;
    text-align: center;
}

.error-message {
    background: #fee2e2;
    color: #991b1b;
    padding: 20px;
    border-radius: 12px;
    border: 1px solid #fca5a5;
    font-weight: 500;
    text-align: center;
}

.loading-container {
    text-align: center;
    padding: 40px;
    display: none;
}

.loading-spinner {
    width: 50px;
    height: 50px;
    border: 4px solid #f3f4f6;
    border-top: 4px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-text {
    color: #6b7280;
    font-size: 1.1rem;
    font-weight: 500;
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .legal-research-page {
        padding: 15px;
    }
    
    .page-header {
        padding: 20px;
    }
    
    .page-title {
        font-size: 2rem;
    }
    
    .research-container, .results-container {
        padding: 25px;
    }
    
    .results-actions {
        flex-direction: column;
    }
    
    .action-btn {
        width: 100%;
        justify-content: center;
    }
}

/* Quick Actions */
.quick-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.quick-action-btn {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    color: #374151;
}

.quick-action-btn:hover {
    border-color: #667eea;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
}

.quick-action-icon {
    font-size: 2rem;
    margin-bottom: 10px;
    display: block;
}

.quick-action-title {
    font-weight: 600;
    margin-bottom: 5px;
}

.quick-action-desc {
    font-size: 0.9rem;
    color: #6b7280;
}
</style>
{% endblock %}

{% block content %}
<div class="legal-research-page">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">üîç Legal Research</h1>
        <p class="page-subtitle">Get intelligent answers about Saudi Arabian law, regulations, and legal precedents from our comprehensive legal database.</p>
        </div>
        
    <!-- Quick Actions -->
    <div class="quick-actions">
        <button class="quick-action-btn" onclick="askQuestion('What are the labor law requirements in Saudi Arabia?')">
            <span class="quick-action-icon">üë•</span>
            <div class="quick-action-title">Labor Law</div>
            <div class="quick-action-desc">Employment regulations and worker rights</div>
        </button>
        <button class="quick-action-btn" onclick="askQuestion('What are the business registration requirements in Saudi Arabia?')">
            <span class="quick-action-icon">üíº</span>
            <div class="quick-action-title">Business Law</div>
            <div class="quick-action-desc">Company formation and regulations</div>
        </button>
        <button class="quick-action-btn" onclick="askQuestion('What are the tax laws and regulations in Saudi Arabia?')">
            <span class="quick-action-icon">üí∞</span>
            <div class="quick-action-title">Tax Law</div>
            <div class="quick-action-desc">Tax obligations and compliance</div>
        </button>
        <button class="quick-action-btn" onclick="askQuestion('What are the intellectual property laws in Saudi Arabia?')">
            <span class="quick-action-icon">üß†</span>
            <div class="quick-action-title">IP Law</div>
            <div class="quick-action-desc">Patents, trademarks, and copyrights</div>
        </button>
    </div>

    <!-- Research Form -->
    <div class="research-container">
        <form id="legalResearchForm" method="POST" action="/legal-research">
            <div class="form-group">
                <label for="query" class="form-label">Your Legal Question</label>
                <textarea 
                    id="query" 
                    name="query" 
                    class="form-textarea" 
                    placeholder="Ask your legal question here... (e.g., What are the requirements for starting a business in Saudi Arabia?)"
                    required
                >{{ query if query else '' }}</textarea>
            </div>
            
            <div class="form-group">
                <label for="jurisdiction" class="form-label">Jurisdiction</label>
                <select id="jurisdiction" name="jurisdiction" class="form-select">
                    <option value="Saudi Arabia" {% if jurisdiction == 'Saudi Arabia' %}selected{% endif %}>üá∏üá¶ Saudi Arabia</option>
                    <option value="UAE" {% if jurisdiction == 'UAE' %}selected{% endif %}>üá¶üá™ United Arab Emirates</option>
                    <option value="Kuwait" {% if jurisdiction == 'Kuwait' %}selected{% endif %}>üá∞üáº Kuwait</option>
                    <option value="Qatar" {% if jurisdiction == 'Qatar' %}selected{% endif %}>üá∂üá¶ Qatar</option>
                    <option value="Bahrain" {% if jurisdiction == 'Bahrain' %}selected{% endif %}>üáßüá≠ Bahrain</option>
                    <option value="Oman" {% if jurisdiction == 'Oman' %}selected{% endif %}>üá¥üá≤ Oman</option>
                </select>
            </div>

            <div class="checkbox-container">
                <input type="checkbox" id="include_web_search" name="include_web_search" {% if include_web_search %}checked{% endif %}>
                <label for="include_web_search">Include web search for additional information</label>
            </div>

            <button type="submit" class="submit-btn" id="submitBtn">
                <span id="submitText">üîç Start Research</span>
                <span id="submitLoading" style="display: none;">‚è≥ Researching...</span>
            </button>
            
            <!-- Fallback for when JavaScript fails -->
            <noscript>
                <button type="submit" class="submit-btn" style="margin-top: 10px;">
                    üîç Submit Research (No JavaScript)
                </button>
            </noscript>
            </form>
        </div>

    <!-- Loading Container -->
    <div class="loading-container" id="loadingContainer">
        <div class="loading-spinner"></div>
        <div class="loading-text">Researching legal information...</div>
        </div>
        
    <!-- Results Container -->
    <div class="results-container" id="resultsContainer">
        <div class="results-header">
            <h2 class="results-title">Research Results</h2>
            <div class="results-actions">
                <button class="action-btn" onclick="startNewResearch()">
                    üîÑ New Research
                </button>
                <button class="action-btn" onclick="window.location.href='/dashboard'">
                    üè† Dashboard
                </button>
            </div>
        </div>
        <div id="resultsContent">
            <!-- Results will be displayed here -->
            </div>
        </div>
        
    <!-- Message Container -->
    <div id="messageContainer" class="message-container">
        {% if error %}
            <div class="error-message">{{ error }}</div>
        {% endif %}
        {% if research_result %}
            <div class="success-message">‚úÖ Research completed successfully!</div>
        {% endif %}
        </div>
</div>

<script>
let isResearching = false;

// Form submission handling
document.getElementById('legalResearchForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const query = document.getElementById('query').value.trim();
    const jurisdiction = document.getElementById('jurisdiction').value;
    const includeWebSearch = document.getElementById('include_web_search').checked;
    
    if (!query) {
        showMessage('Please enter a legal question.', 'error');
        return;
    }
    
    if (isResearching) {
        return;
    }
    
    isResearching = true;
    showLoading();
    
    const formData = new FormData();
    formData.append('query', query);
    formData.append('jurisdiction', jurisdiction);
    if (includeWebSearch) {
        formData.append('include_web_search', 'on');
    }
    
    fetch('/legal-research', {
        method: 'POST',
        body: formData,
        credentials: 'same-origin'  // Include cookies/session
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (response.status === 200) {
            return response.text();
        } else if (response.status === 303) {
            // Handle redirect to login
            window.location.href = '/login';
            return;
        } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
    })
    .then(html => {
        console.log('Legal research response received, length:', html.length);
        console.log('Response preview:', html.substring(0, 500) + '...');
        
        // Parse the response to extract research results
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        // Look for the research result
        let researchResult = null;
        
        // Check if we got redirected to login page
        if (html.includes('Login - DALI Legal AI') || html.includes('loginForm')) {
            researchResult = 'Authentication session expired. Please refresh the page and try again. If the problem persists, please log out and log back in.';
        } else if (html.includes('research_result') || html.includes('Research Results')) {
            // Look for server-rendered research result
            const serverResult = doc.querySelector('.result-content');
            if (serverResult && serverResult.textContent.trim()) {
                researchResult = serverResult.textContent.trim();
            } else {
                // Try to find any meaningful content in the response
                const bodyText = doc.body.textContent.trim();
                const lines = bodyText.split('\n').filter(line => {
                    const trimmed = line.trim();
                    return trimmed.length > 50 && 
                           !trimmed.includes('DALI Legal AI') && 
                           !trimmed.includes('Navigation') &&
                           !trimmed.includes('Settings') &&
                           !trimmed.includes('Legal Research') &&
                           !trimmed.includes('Ask Your Legal Question') &&
                           !trimmed.includes('Enter your legal question') &&
                           !trimmed.includes('Jurisdiction') &&
                           !trimmed.includes('Include web search') &&
                           !trimmed.includes('Start Research') &&
                           !trimmed.includes('Get intelligent answers about Saudi Arabian law');
                });
                
                if (lines.length > 0) {
                    researchResult = lines[0].trim();
                }
            }
        } else {
        // Try different selectors that might contain the research result
        const resultSelectors = [
            '.legal-research-result',
            '.research-result',
            '.result',
            '.answer',
            '.response',
                '#resultsContent',
                '.result-content',
                'p'
        ];
        
        for (const selector of resultSelectors) {
            const element = doc.querySelector(selector);
            if (element && element.textContent.trim()) {
                    const text = element.textContent.trim();
                    // Skip generic placeholder text
                    if (!text.includes('Get intelligent answers about Saudi Arabian law') && 
                        !text.includes('Ask your legal question here') &&
                        text.length > 20) {
                        researchResult = text;
                break;
                    }
            }
        }
        
        // If no specific result found, look for any meaningful content
            if (!researchResult) {
            const bodyText = doc.body.textContent.trim();
                const lines = bodyText.split('\n').filter(line => {
                    const trimmed = line.trim();
                    return trimmed.length > 50 && 
                           !trimmed.includes('DALI Legal AI') && 
                           !trimmed.includes('Navigation') &&
                           !trimmed.includes('Settings') &&
                           !trimmed.includes('Legal Research') &&
                           !trimmed.includes('Ask Your Legal Question') &&
                           !trimmed.includes('Enter your legal question') &&
                           !trimmed.includes('Jurisdiction') &&
                           !trimmed.includes('Include web search') &&
                           !trimmed.includes('Start Research') &&
                           !trimmed.includes('Get intelligent answers about Saudi Arabian law');
                });
                
                if (lines.length > 0) {
                    researchResult = lines[0].trim();
                }
            }
        }
        
        // Final fallback
        if (!researchResult) {
            // Show a test response to verify the display is working
            researchResult = `Test Response: I received your question "${query}" but was unable to parse the server response properly. This indicates there might be an issue with the response parsing. The server might be working, but the JavaScript is not extracting the result correctly.

Debug Information:
- Response length: ${html.length} characters
- Contains 'research_result': ${html.includes('research_result')}
- Contains 'Research Results': ${html.includes('Research Results')}
- Contains login form: ${html.includes('loginForm')}

Please check the browser console for more details.`;
        }
        
        displayResults(researchResult);
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Error researching legal information. Please try again.', 'error');
    })
    .finally(() => {
        isResearching = false;
        hideLoading();
    });
});

function askQuestion(question) {
    document.getElementById('query').value = question;
    document.getElementById('legalResearchForm').dispatchEvent(new Event('submit'));
}

function showLoading() {
    document.getElementById('loadingContainer').style.display = 'block';
    document.getElementById('submitBtn').disabled = true;
    document.getElementById('submitText').style.display = 'none';
    document.getElementById('submitLoading').style.display = 'inline';
}

function hideLoading() {
    document.getElementById('loadingContainer').style.display = 'none';
    document.getElementById('submitBtn').disabled = false;
    document.getElementById('submitText').style.display = 'inline';
    document.getElementById('submitLoading').style.display = 'none';
}

function displayResults(result) {
    const resultsContent = document.getElementById('resultsContent');
    
    resultsContent.innerHTML = `
        <div class="result-content">
            ${result}
        </div>
        <div class="result-actions">
            <button class="action-btn" onclick="copyToClipboard('${result.replace(/'/g, "\\'")}')">
                üìã Copy Result
                            </button>
            <button class="action-btn primary" onclick="addToKnowledgeBase('Legal Research Result', '${result.replace(/'/g, "\\'")}', 'Legal Research')">
                üìö Add to Knowledge Base
                            </button>
                        </div>
                    `;
                    
    document.getElementById('resultsContainer').style.display = 'block';
    document.getElementById('resultsContainer').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
    });
}

function showMessage(message, type) {
    const messageContainer = document.getElementById('messageContainer');
    const messageClass = type === 'error' ? 'error-message' : 'success-message';
    messageContainer.innerHTML = `<div class="${messageClass}">${message}</div>`;
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        messageContainer.innerHTML = '';
    }, 5000);
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showMessage('Result copied to clipboard!', 'success');
    }).catch(err => {
        console.error('Failed to copy: ', err);
        showMessage('Failed to copy result', 'error');
    });
}

function addToKnowledgeBase(title, content, source) {
    fetch('/api/knowledge-base/add-analysis', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            title: title,
            content: content,
            document_type: 'legal_research',
            source: source
        })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
            showMessage('Result added to knowledge base successfully!', 'success');
        } else {
            showMessage('Error adding to knowledge base: ' + data.error, 'error');
            }
        })
        .catch(error => {
        console.error('Error:', error);
        showMessage('Error adding to knowledge base', 'error');
        });
}

function startNewResearch() {
    // Reset form
    document.getElementById('query').value = '';
    document.getElementById('jurisdiction').value = 'Saudi Arabia';
    document.getElementById('include_web_search').checked = false;
    
    // Hide results and loading
    document.getElementById('resultsContainer').style.display = 'none';
    document.getElementById('loadingContainer').style.display = 'none';
    
    // Clear messages
    document.getElementById('messageContainer').innerHTML = '';
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('query').focus();
    
    // Check if there are server results and display them
    {% if research_result %}
        console.log('Server research result found:', '{{ research_result|length }}' + ' characters');
        displayResults('{{ research_result|replace("'", "\\'")|replace('"', '\\"')|replace('\n', '\\n') }}');
    {% endif %}
});
</script>
{% endblock %}