{% extends "chatgpt_base.html" %}
{% block title %}{{ t('legal_research') if t else 'Legal Research' }} - DALI Legal AI{% endblock %}

{% block head %}
<link rel="stylesheet" href="/static/chatgpt-ui.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="chatgpt-layout chatgpt-legal-research">
    <!-- ChatGPT-Style Sidebar -->
    <aside class="chatgpt-sidebar" id="sidebar">
        <div class="chatgpt-sidebar-header">
            <div class="chatgpt-sidebar-title">‚öñÔ∏è DALI Legal AI</div>
            <div class="chatgpt-sidebar-subtitle">{{ t('welcome_subtitle') if t else 'Your intelligent legal assistant' }}</div>
        </div>
        
        <button class="chatgpt-new-chat-btn" onclick="startNewResearch()">
            <span>+</span>
            {{ t('new_research') if t else 'New Research' }}
        </button>
        
        <nav class="chatgpt-nav">
            <div class="chatgpt-nav-section">
                <div class="chatgpt-nav-section-title">{{ t('legal_tools') if t else 'Legal Tools' }}</div>
                <div class="chatgpt-nav-item">
                    <a href="/dashboard" class="chatgpt-nav-link">
                        <span class="chatgpt-nav-icon">üè†</span>
                        {{ t('dashboard') if t else 'Dashboard' }}
                    </a>
                </div>
                <div class="chatgpt-nav-item">
                    <a href="/legal-research" class="chatgpt-nav-link active">
                        <span class="chatgpt-nav-icon">üîç</span>
                        {{ t('legal_research') if t else 'Legal Research' }}
                    </a>
                </div>
                <div class="chatgpt-nav-item">
                    <a href="/document-analysis" class="chatgpt-nav-link">
                        <span class="chatgpt-nav-icon">üìÑ</span>
                        {{ t('document_analysis') if t else 'Document Analysis' }}
                    </a>
                </div>
                <div class="chatgpt-nav-item">
                    <a href="/knowledge-base" class="chatgpt-nav-link">
                        <span class="chatgpt-nav-icon">üìö</span>
                        {{ t('knowledge_base') if t else 'Knowledge Base' }}
                    </a>
                </div>
                <div class="chatgpt-nav-item">
                    <a href="/web-research" class="chatgpt-nav-link">
                        <span class="chatgpt-nav-icon">üåê</span>
                        {{ t('web_research') if t else 'Web Research' }}
                    </a>
                </div>
            </div>
            
            <div class="chatgpt-nav-section">
                <div class="chatgpt-nav-section-title">{{ t('account') if t else 'Account' }}</div>
                <div class="chatgpt-nav-item">
                    <a href="/settings" class="chatgpt-nav-link">
                        <span class="chatgpt-nav-icon">‚öôÔ∏è</span>
                        {{ t('settings') if t else 'Settings' }}
                    </a>
                </div>
                {% if user and user.role == 'admin' %}
                <div class="chatgpt-nav-item">
                    <a href="/admin/dashboard" class="chatgpt-nav-link">
                        <span class="chatgpt-nav-icon">üëë</span>
                        {{ t('admin_panel') if t else 'Admin Panel' }}
                    </a>
                </div>
                {% endif %}
            </div>
        </nav>
        
        <!-- Conversation History -->
        <div class="chatgpt-conversation-history" id="conversationHistory">
            <div class="chatgpt-nav-section">
                <div class="chatgpt-nav-section-title">{{ t('recent_research') if t else 'Recent Research' }}</div>
                <div id="conversationList" class="chatgpt-conversation-list">
                    <!-- Conversations will be loaded here -->
                </div>
            </div>
        </div>
        
        {% if user %}
        <div class="chatgpt-user-info">
            <div class="chatgpt-user-greeting">{{ t('hello') if t else 'Hello' }}, {{ user.greeting_name or user.username }}</div>
            <div class="chatgpt-user-role">{{ t('role_' + user.role) if t else user.role.title() }}</div>
            <form method="get" action="/logout">
                <button type="submit" class="chatgpt-logout-btn">
                    {{ t('logout') if t else 'Logout' }}
                </button>
            </form>
        </div>
        {% endif %}
    </aside>
    
    <!-- Main Legal Research Interface -->
    <main class="chatgpt-main">
        <!-- Mobile Menu Button -->
        <button class="chatgpt-mobile-menu" onclick="toggleSidebar()">
            ‚ò∞
        </button>
        
        <!-- Research Header -->
        <div class="chatgpt-header">
            <div class="chatgpt-header-title">{{ t('legal_research') if t else 'Legal Research' }}</div>
            <div class="chatgpt-header-subtitle">{{ t('legal_research_subtitle') if t else 'Ask questions about Saudi Arabian law and get intelligent answers' }}</div>
        </div>
        
        <!-- Welcome Screen -->
        <div class="chatgpt-welcome" id="welcomeScreen">
            <div class="chatgpt-welcome-icon">üîç</div>
            <h1 class="chatgpt-welcome-title">{{ t('legal_research') if t else 'Legal Research' }}</h1>
            <p class="chatgpt-welcome-subtitle">{{ t('legal_research_description') if t else 'Ask questions about Saudi Arabian law, regulations, and legal precedents. Get intelligent answers based on our comprehensive legal database.' }}</p>
            
            <div class="chatgpt-welcome-actions">
                <button class="chatgpt-action-btn" onclick="askQuestion('What are the requirements for starting a business in Saudi Arabia?')">
                    üíº {{ t('business_law') if t else 'Business Law' }}
                </button>
                <button class="chatgpt-action-btn" onclick="askQuestion('What are the labor law requirements in Saudi Arabia?')">
                    üë• {{ t('labor_law') if t else 'Labor Law' }}
                </button>
                <button class="chatgpt-action-btn" onclick="askQuestion('What are the tax regulations in Saudi Arabia?')">
                    üí∞ {{ t('tax_law') if t else 'Tax Law' }}
                </button>
                <button class="chatgpt-action-btn" onclick="askQuestion('What are the intellectual property laws in Saudi Arabia?')">
                    üß† {{ t('ip_law') if t else 'Intellectual Property' }}
                </button>
            </div>
        </div>
        
        <!-- Research Result Display (for form submissions) -->
        {% if research_result %}
        <div class="chatgpt-research-result" id="researchResult" data-conversation-id="{{ conversation_id }}">
            <div class="chatgpt-research-header">
                <h2>{{ t('research_result') if t else 'Research Result' }}</h2>
                <p class="chatgpt-research-query">{{ t('query') if t else 'Query' }}: {{ query }}</p>
            </div>
            <div class="chatgpt-research-content">
                <div class="legal-research-result">{{ research_result }}</div>
            </div>
        </div>
        {% endif %}
        
        <!-- Chat Messages Area -->
        <div class="chatgpt-messages" id="chatMessages" style="display: none;">
            <!-- Messages will be dynamically added here -->
        </div>
        
        <!-- Input Area -->
        <div class="chatgpt-input-area">
            <div class="chatgpt-input-container">
                <textarea 
                    class="chatgpt-input" 
                    id="chatInput" 
                    placeholder="{{ t('ask_legal_question') if t else 'Ask your legal question here...' }}"
                    rows="1"
                    onkeydown="handleKeyDown(event)"
                    oninput="autoResize(this)"
                ></textarea>
                <button class="chatgpt-voice-btn" id="voiceBtn" onclick="toggleVoiceRecording()" title="{{ t('voice_input') if t else 'Voice Input' }}">
                    üé§
                </button>
                <button class="chatgpt-send-btn" id="sendBtn" onclick="sendMessage()">
                    ‚û§
                </button>
            </div>
            <div id="voice-status" class="voice-status" style="display: none;">
                <span id="voice-status-text">{{ t('listening') if t else 'Listening...' }}</span>
                <button class="voice-stop-btn" onclick="stopVoiceRecording()">‚èπÔ∏è</button>
            </div>
        </div>
    </main>
</div>

<script>
let currentResearchId = null;
let currentConversationId = null;
let isTyping = false;
let isRecording = false;
let recognition = null;

// Voice-to-Text Functions
function initializeSpeechRecognition() {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        
        recognition.continuous = false;
        recognition.interimResults = true;
        recognition.lang = 'en-US'; // Default to English, can be changed based on user preference
        
        recognition.onstart = function() {
            isRecording = true;
            document.getElementById('voiceBtn').classList.add('recording');
            document.getElementById('voiceBtn').innerHTML = 'üî¥';
            document.getElementById('voice-status').style.display = 'flex';
            document.getElementById('voice-status-text').textContent = '{{ t("listening") if t else "Listening..." }}';
        };
        
        recognition.onresult = function(event) {
            let interimTranscript = '';
            let finalTranscript = '';
            
            for (let i = event.resultIndex; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                    finalTranscript += transcript;
                } else {
                    interimTranscript += transcript;
                }
            }
            
            // Update the input field with interim results
            const chatInput = document.getElementById('chatInput');
            if (interimTranscript) {
                chatInput.value = finalTranscript + interimTranscript;
                autoResize(chatInput);
            }
            
            // If we have final results, use them
            if (finalTranscript) {
                chatInput.value = finalTranscript;
                autoResize(chatInput);
            }
        };
        
        recognition.onerror = function(event) {
            console.error('Speech recognition error:', event.error);
            stopVoiceRecording();
            alert('{{ t("voice_recognition_error") if t else "Voice recognition error. Please try again." }}');
        };
        
        recognition.onend = function() {
            stopVoiceRecording();
        };
    } else {
        console.warn('Speech recognition not supported');
        alert('{{ t("voice_not_supported") if t else "Voice recognition is not supported in this browser." }}');
    }
}

function toggleVoiceRecording() {
    if (!recognition) {
        initializeSpeechRecognition();
    }
    
    if (isRecording) {
        stopVoiceRecording();
    } else {
        startVoiceRecording();
    }
}

function startVoiceRecording() {
    if (recognition) {
        try {
            recognition.start();
        } catch (error) {
            console.error('Error starting voice recognition:', error);
            alert('{{ t("error_starting_voice") if t else "Error starting voice recognition. Please try again." }}');
        }
    }
}

function stopVoiceRecording() {
    if (recognition && isRecording) {
        recognition.stop();
    }
    
    isRecording = false;
    document.getElementById('voiceBtn').classList.remove('recording');
    document.getElementById('voiceBtn').innerHTML = 'üé§';
    document.getElementById('voice-status').style.display = 'none';
}

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('open');
}

function startNewResearch() {
    currentResearchId = null;
    document.getElementById('welcomeScreen').style.display = 'flex';
    document.getElementById('chatMessages').style.display = 'none';
    document.getElementById('chatInput').value = '';
    document.getElementById('chatInput').focus();
}

function askQuestion(question) {
    document.getElementById('chatInput').value = question;
    sendMessage();
}

function autoResize(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
}

function handleKeyDown(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
    }
}

function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message || isTyping) return;
    
    // Hide welcome screen and show messages
    document.getElementById('welcomeScreen').style.display = 'none';
    document.getElementById('chatMessages').style.display = 'flex';
    
    // Add user message
    addMessage('user', message);
    
    // Clear input
    input.value = '';
    input.style.height = 'auto';
    
    // Show typing indicator
    showTypingIndicator();
    
    // Send to legal research API with conversation ID
    const formData = new FormData();
    formData.append('query', message);
    formData.append('jurisdiction', 'Saudi Arabia');
    formData.append('include_web_search', '');
    if (currentConversationId) {
        formData.append('conversation_id', currentConversationId);
    }
    
    fetch('/legal-research', {
        method: 'POST',
        body: formData
    })
    .then(response => response.text())
    .then(html => {
        hideTypingIndicator();
        // Extract the answer from the response
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        // Extract conversation ID from the response
        const conversationIdElement = doc.querySelector('[data-conversation-id]');
        if (conversationIdElement) {
            currentConversationId = conversationIdElement.getAttribute('data-conversation-id');
        }
        
        // Look for research result in various possible locations
        let answer = 'I found some relevant information, but there was an issue processing the response.';
        
        // Try different selectors that might contain the research result
        const resultSelectors = [
            '.legal-research-result',
            '.research-result',
            '.result',
            '.answer',
            '.response',
            'p',
            '.content'
        ];
        
        for (const selector of resultSelectors) {
            const element = doc.querySelector(selector);
            if (element && element.textContent.trim()) {
                answer = element.textContent.trim();
                break;
            }
        }
        
        // If no specific result found, look for any meaningful content
        if (answer.includes('issue processing')) {
            const bodyText = doc.body.textContent.trim();
            if (bodyText && bodyText.length > 50) {
                // Extract meaningful content (skip navigation, headers, etc.)
                const lines = bodyText.split('\n').filter(line => 
                    line.trim().length > 20 && 
                    !line.includes('DALI') && 
                    !line.includes('Navigation') && 
                    !line.includes('Settings')
                );
                if (lines.length > 0) {
                    answer = lines[0].trim();
                }
            }
        }
        
        addMessage('assistant', answer);
        
        // Refresh conversation list
        loadConversations();
    })
    .catch(error => {
        hideTypingIndicator();
        addMessage('assistant', 'I apologize, but I encountered an error while searching for legal information. Please try again.');
        console.error('Error:', error);
    });
}

function formatMessage(text) {
    // Convert the text to HTML with proper formatting
    let formatted = text
        // Convert numbered lists (1. **text**: description)
        .replace(/(\d+)\.\s*\*\*(.*?)\*\*:\s*(.*?)(?=\d+\.\s*\*\*|$)/gs, (match, num, title, desc) => {
            return `<div class="chatgpt-list-item">
                <div class="chatgpt-list-number">${num}.</div>
                <div class="chatgpt-list-content">
                    <div class="chatgpt-list-title">${title}</div>
                    <div class="chatgpt-list-description">${desc.trim()}</div>
                </div>
            </div>`;
        })
        // Convert bold text **text** to <strong>text</strong>
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        // Convert line breaks to <br>
        .replace(/\n/g, '<br>')
        // Convert double line breaks to paragraph breaks
        .replace(/(<br>\s*){2,}/g, '</p><p>')
        // Wrap in paragraph tags
        .replace(/^(.*)$/, '<p>$1</p>')
        // Clean up empty paragraphs
        .replace(/<p><\/p>/g, '')
        .replace(/<p><br><\/p>/g, '');
    
    return formatted;
}

function addMessage(sender, text) {
    const messagesContainer = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'chatgpt-message';
    
    const avatar = document.createElement('div');
    avatar.className = `chatgpt-message-avatar ${sender}`;
    avatar.textContent = sender === 'user' ? 'U' : 'AI';
    
    const content = document.createElement('div');
    content.className = 'chatgpt-message-content';
    
    const textDiv = document.createElement('div');
    textDiv.className = 'chatgpt-message-text';
    
    if (sender === 'assistant') {
        // Format AI responses with proper HTML
        textDiv.innerHTML = formatMessage(text);
    } else {
        // Keep user messages as plain text
        textDiv.textContent = text;
    }
    
    const metaDiv = document.createElement('div');
    metaDiv.className = 'chatgpt-message-meta';
    metaDiv.textContent = new Date().toLocaleTimeString();
    
    content.appendChild(textDiv);
    content.appendChild(metaDiv);
    
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(content);
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function showTypingIndicator() {
    isTyping = true;
    const messagesContainer = document.getElementById('chatMessages');
    const typingDiv = document.createElement('div');
    typingDiv.className = 'chatgpt-message';
    typingDiv.id = 'typingIndicator';
    
    const avatar = document.createElement('div');
    avatar.className = 'chatgpt-message-avatar assistant';
    avatar.textContent = 'AI';
    
    const content = document.createElement('div');
    content.className = 'chatgpt-message-content';
    
    const typingContent = document.createElement('div');
    typingContent.className = 'chatgpt-typing';
    typingContent.innerHTML = `
        <span>AI is researching...</span>
        <div class="chatgpt-typing-dots">
            <div class="chatgpt-typing-dot"></div>
            <div class="chatgpt-typing-dot"></div>
            <div class="chatgpt-typing-dot"></div>
        </div>
    `;
    
    content.appendChild(typingContent);
    
    typingDiv.appendChild(avatar);
    typingDiv.appendChild(content);
    
    messagesContainer.appendChild(typingDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function hideTypingIndicator() {
    isTyping = false;
    const typingIndicator = document.getElementById('typingIndicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

// Conversation Management Functions
function loadConversations() {
    fetch('/api/conversations')
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to load conversations');
            }
            return response.json();
        })
        .then(data => {
            const conversationList = document.getElementById('conversationList');
            conversationList.innerHTML = '';
            
            if (data.conversations && data.conversations.length > 0) {
                data.conversations.forEach(conversation => {
                    const conversationItem = document.createElement('div');
                    conversationItem.className = 'chatgpt-conversation-item';
                    conversationItem.setAttribute('data-conversation-id', conversation.id);
                    
                    if (conversation.id == currentConversationId) {
                        conversationItem.classList.add('active');
                    }
                    
                    conversationItem.innerHTML = `
                        <div class="chatgpt-conversation-title">${conversation.title}</div>
                        <div class="chatgpt-conversation-actions">
                            <button class="chatgpt-conversation-action" onclick="loadConversation(${conversation.id})" title="Load Conversation">
                                üìÇ
                            </button>
                            <button class="chatgpt-conversation-action delete" onclick="deleteConversation(${conversation.id})" title="Delete Conversation">
                                üóëÔ∏è
                            </button>
                        </div>
                    `;
                    
                    conversationItem.addEventListener('click', (e) => {
                        if (!e.target.closest('.chatgpt-conversation-action')) {
                            loadConversation(conversation.id);
                        }
                    });
                    
                    conversationList.appendChild(conversationItem);
                });
            } else {
                // Show empty state
                conversationList.innerHTML = '<div class="chatgpt-conversation-empty">No conversations yet</div>';
            }
        })
        .catch(error => {
            console.error('Error loading conversations:', error);
            const conversationList = document.getElementById('conversationList');
            conversationList.innerHTML = '<div class="chatgpt-conversation-empty">Conversations unavailable</div>';
        });
}

function loadConversation(conversationId) {
    currentConversationId = conversationId;
    
    // Update active conversation in sidebar
    document.querySelectorAll('.chatgpt-conversation-item').forEach(item => {
        item.classList.remove('active');
    });
    document.querySelector(`[data-conversation-id="${conversationId}"]`).classList.add('active');
    
    // Load conversation messages
    fetch(`/api/conversations/${conversationId}/messages`)
        .then(response => response.json())
        .then(data => {
            // Clear current messages
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '';
            
            // Hide welcome screen and show messages
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('chatMessages').style.display = 'flex';
            
            // Add all messages
            data.messages.forEach(message => {
                addMessage(message.sender_type, message.message);
            });
        })
        .catch(error => {
            console.error('Error loading conversation:', error);
        });
}

function deleteConversation(conversationId) {
    if (confirm('Are you sure you want to delete this conversation?')) {
        fetch(`/api/conversations/${conversationId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // If we deleted the current conversation, start fresh
                if (conversationId == currentConversationId) {
                    currentConversationId = null;
                    document.getElementById('welcomeScreen').style.display = 'block';
                    document.getElementById('chatMessages').style.display = 'none';
                    document.getElementById('chatMessages').innerHTML = '';
                }
                loadConversations();
            }
        })
        .catch(error => {
            console.error('Error deleting conversation:', error);
        });
    }
}

function startNewResearch() {
    currentConversationId = null;
    document.getElementById('welcomeScreen').style.display = 'block';
    document.getElementById('chatMessages').style.display = 'none';
    document.getElementById('chatMessages').innerHTML = '';
    
    // Remove active state from all conversations
    document.querySelectorAll('.chatgpt-conversation-item').forEach(item => {
        item.classList.remove('active');
    });
    
    // Focus on input
    document.getElementById('chatInput').focus();
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('chatInput').focus();
    
    // Try to load conversations, but don't fail if it doesn't work
    try {
        loadConversations();
    } catch (error) {
        console.log('Conversation loading disabled:', error);
        const conversationList = document.getElementById('conversationList');
        if (conversationList) {
            conversationList.innerHTML = '<div class="chatgpt-conversation-empty">Conversations unavailable</div>';
        }
    }
    
    // Close sidebar on mobile when clicking outside
    document.addEventListener('click', function(event) {
        const sidebar = document.getElementById('sidebar');
        const mobileMenu = document.querySelector('.chatgpt-mobile-menu');
        
        if (window.innerWidth <= 768 && 
            !sidebar.contains(event.target) && 
            !mobileMenu.contains(event.target)) {
            sidebar.classList.remove('open');
        }
    });
});
</script>
{% endblock %}
