{% extends "chatgpt_base.html" %}
{% block title %}DALI Legal AI{% endblock %}

{% block head %}
<link rel="stylesheet" href="/static/chatgpt-ui.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="chatgpt-layout">
    <!-- ChatGPT-Style Sidebar -->
    <aside class="chatgpt-sidebar" id="sidebar">
        <div class="chatgpt-sidebar-header">
            <div class="chatgpt-sidebar-title">‚öñÔ∏è DALI Legal AI</div>
            <div class="chatgpt-sidebar-subtitle">{{ t('welcome_subtitle') if t else 'Your intelligent legal assistant' }}</div>
        </div>
        
        <button class="chatgpt-new-chat-btn" onclick="startNewChat()">
            <span>+</span>
            {{ t('new_chat') if t else 'New Chat' }}
        </button>
        
        <nav class="chatgpt-nav">
            <div class="chatgpt-nav-section">
                <div class="chatgpt-nav-section-title">{{ t('enhanced_features') if t else 'Enhanced Features' }}</div>
                <div class="chatgpt-nav-item">
                    <a href="/enhanced-dashboard" class="chatgpt-nav-link {% if active_page=='enhanced-dashboard' %}active{% endif %}">
                        <span class="chatgpt-nav-icon">‚≠ê</span>
                        {{ t('enhanced_dashboard') if t else 'Enhanced Dashboard' }}
                        <span class="feature-badge">v1.2.0</span>
                    </a>
                </div>
                <div class="chatgpt-nav-item">
                    <a href="/api/docs" target="_blank" class="chatgpt-nav-link">
                        <span class="chatgpt-nav-icon">üìñ</span>
                        {{ t('api_documentation') if t else 'API Documentation' }}
                    </a>
                </div>
            </div>
            
            <div class="chatgpt-nav-section">
                <div class="chatgpt-nav-section-title">{{ t('legal_tools') if t else 'Legal Tools' }}</div>
                <div class="chatgpt-nav-item">
                    <a href="/legal-research" class="chatgpt-nav-link {% if active_page=='legal-research' %}active{% endif %}">
                        <span class="chatgpt-nav-icon">üîç</span>
                        {{ t('legal_research') if t else 'Legal Research' }}
                    </a>
                </div>
                <div class="chatgpt-nav-item">
                    <a href="/document-analysis" class="chatgpt-nav-link {% if active_page=='document-analysis' %}active{% endif %}">
                        <span class="chatgpt-nav-icon">üìÑ</span>
                        {{ t('document_analysis') if t else 'Document Analysis' }}
                    </a>
                </div>
                <div class="chatgpt-nav-item">
                    <a href="/enhanced-knowledge-base" class="chatgpt-nav-link {% if active_page=='enhanced-knowledge-base' %}active{% endif %}">
                        <span class="chatgpt-nav-icon">üìö</span>
                        {{ t('enhanced_knowledge_base') if t else 'Enhanced Knowledge Base' }}
                        <span class="feature-badge" style="margin-left: 8px;">NEW</span>
                    </a>
                </div>
                <div class="chatgpt-nav-item">
                    <a href="/knowledge-base" class="chatgpt-nav-link {% if active_page=='knowledge-base' %}active{% endif %}">
                        <span class="chatgpt-nav-icon">üìñ</span>
                        {{ t('knowledge_base') if t else 'Knowledge Base' }}
                        <span style="font-size: 0.7rem; color: #6b7280;">(Legacy)</span>
                    </a>
                </div>
                <div class="chatgpt-nav-item">
                    <a href="/web-research" class="chatgpt-nav-link {% if active_page=='web-research' %}active{% endif %}">
                        <span class="chatgpt-nav-icon">üåê</span>
                        {{ t('web_research') if t else 'Web Research' }}
                    </a>
                </div>
            </div>
            
            <div class="chatgpt-nav-section">
                <div class="chatgpt-nav-section-title">{{ t('account') if t else 'Account' }}</div>
                <div class="chatgpt-nav-item">
                    <a href="/settings" class="chatgpt-nav-link {% if active_page=='settings' %}active{% endif %}">
                        <span class="chatgpt-nav-icon">‚öôÔ∏è</span>
                        {{ t('settings') if t else 'Settings' }}
                    </a>
                </div>
                {% if user and user.role == 'admin' %}
                <div class="chatgpt-nav-item">
                    <a href="/admin/dashboard" class="chatgpt-nav-link {% if active_page=='admin-dashboard' %}active{% endif %}">
                        <span class="chatgpt-nav-icon">üëë</span>
                        {{ t('admin_panel') if t else 'Admin Panel' }}
                    </a>
                </div>
                {% endif %}
            </div>
        </nav>
        
        {% if user %}
        <div class="chatgpt-user-info">
            <div class="chatgpt-user-greeting">{{ t('hello') if t else 'Hello' }}, {{ user.greeting_name or user.username }}</div>
            <div class="chatgpt-user-role">{{ t('role_' + user.role) if t else user.role.title() }}</div>
            <form method="get" action="/logout">
                <button type="submit" class="chatgpt-logout-btn">
                    {{ t('logout') if t else 'Logout' }}
                </button>
            </form>
        </div>
        {% endif %}
    </aside>
    
    <!-- Main Chat Interface -->
    <main class="chatgpt-main">
        <!-- Mobile Menu Button -->
        <button class="chatgpt-mobile-menu" onclick="toggleSidebar()">
            ‚ò∞
        </button>
        
        <!-- Enhanced Header -->
        <div class="chatgpt-header">
            <div class="chatgpt-header-title">
                {{ t('welcome_title') if t else 'Welcome to DALI Legal AI' }}
                <span class="feature-badge" style="margin-left: 15px;">Enhanced v1.2.0</span>
            </div>
            <div class="chatgpt-header-subtitle">{{ t('welcome_subtitle') if t else 'Your intelligent legal research and document analysis assistant with advanced database intelligence and web scraping capabilities' }}</div>
            
            <!-- System Status -->
            <div class="system-status" style="margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 8px; border: 1px solid #e5e7eb;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span style="font-weight: 600; color: #374151;">System Status</span>
                    <button onclick="checkSystemHealth()" style="padding: 4px 8px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div id="system-status-indicators" style="display: flex; gap: 20px; font-size: 14px;">
                    <div><span class="status-indicator status-offline" id="ollama-status"></span>Ollama AI</div>
                    <div><span class="status-indicator status-offline" id="database-status"></span>MySQL DB</div>
                    <div><span class="status-indicator status-offline" id="firecrawl-status"></span>Firecrawl</div>
                    <div><span class="status-indicator status-offline" id="sample-db-status"></span>Sample Data</div>
                </div>
            </div>
        </div>
        
        <!-- Enhanced Features Showcase -->
        <div class="enhanced-features" style="margin: 30px 0;">
            <h3 style="color: #374151; margin-bottom: 20px; font-size: 1.5rem;">
                <i class="fas fa-star" style="color: #fbbf24; margin-right: 8px;"></i>
                New Enhanced Features
            </h3>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <!-- Database Intelligence -->
                <div class="feature-card" onclick="window.open('/api/docs#/knowledge-base', '_blank')" style="padding: 20px; background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                            <i class="fas fa-database" style="color: white; font-size: 18px;"></i>
                        </div>
                        <div>
                            <h4 style="margin: 0; color: #374151; font-size: 1.1rem;">Database Intelligence</h4>
                            <span class="feature-badge">NEW</span>
                        </div>
                    </div>
                    <p style="color: #6b7280; margin: 0 0 15px 0; font-size: 0.9rem;">Query your legal databases with natural language. Generate SQL, create charts, and analyze your practice data with AI-powered intelligence.</p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <span style="background: #f3f4f6; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; color: #374151;">Natural Language to SQL</span>
                        <span style="background: #f3f4f6; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; color: #374151;">Interactive Charts</span>
                        <span style="background: #f3f4f6; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; color: #374151;">Query History</span>
                    </div>
                </div>
                
                <!-- Web Scraping & Analysis -->
                <div class="feature-card" onclick="window.open('/api/docs#/web-scraping', '_blank')" style="padding: 20px; background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                            <i class="fas fa-globe" style="color: white; font-size: 18px;"></i>
                        </div>
                        <div>
                            <h4 style="margin: 0; color: #374151; font-size: 1.1rem;">Web Scraping & Analysis</h4>
                            <span class="feature-badge" style="background: #10b981;">NEW</span>
                        </div>
                    </div>
                    <p style="color: #6b7280; margin: 0 0 15px 0; font-size: 0.9rem;">Extract and analyze legal content from any website. Monitor regulatory changes, research case law, and gather legal intelligence automatically.</p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <span style="background: #f3f4f6; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; color: #374151;">Firecrawl Integration</span>
                        <span style="background: #f3f4f6; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; color: #374151;">Document Extraction</span>
                        <span style="background: #f3f4f6; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; color: #374151;">Content Analysis</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Section -->
        <div class="search-section">
            <div class="search-prompt">{{ t('what_to_search_today') if t else 'What do you want to search for today?' }}</div>
            <div class="search-container">
                <div class="search-bar">
                    <select class="search-filter">
                        <option value="all">{{ t('all_results') if t else 'All Results' }}</option>
                        <option value="legal_research">{{ t('legal_research') if t else 'Legal Research' }}</option>
                        <option value="document_analysis">{{ t('document_analysis') if t else 'Document Analysis' }}</option>
                        <option value="knowledge_base">{{ t('knowledge_base') if t else 'Knowledge Base' }}</option>
                    </select>
                    <input type="text" class="search-input" placeholder="{{ t('search_here') if t else 'Search here...' }}" id="mainSearchInput">
                    <button class="search-btn" onclick="performMainSearch()">üîç</button>
                </div>
            </div>
            
            <!-- Category Filters -->
            <div class="category-filters">
                <button class="category-btn" data-category="systems" onclick="filterByCategory('systems')">
                    <div class="category-dot green"></div>
                    {{ t('systems_regulations') if t else 'Systems / Regulations' }}
                </button>
                <button class="category-btn" data-category="precedents" onclick="filterByCategory('precedents')">
                    <div class="category-dot yellow"></div>
                    {{ t('judicial_precedents') if t else 'Judicial Precedents' }}
                </button>
                <button class="category-btn" data-category="orders" onclick="filterByCategory('orders')">
                    <div class="category-dot red"></div>
                    {{ t('orders_directives') if t else 'Orders / Directives' }}
                </button>
                <button class="category-btn" data-category="books" onclick="filterByCategory('books')">
                    <div class="category-dot blue"></div>
                    {{ t('books_sources') if t else 'Books / Sources' }}
                </button>
                <button class="category-btn" data-category="forms" onclick="filterByCategory('forms')">
                    <div class="category-dot grey"></div>
                    {{ t('supporting_forms') if t else 'Supporting Forms' }}
                </button>
            </div>
        </div>
        
        <!-- Content Updates Section -->
        <div class="content-updates">
            <div class="updates-header">
                <h3>{{ t('saudi_law_updates') if t else 'Saudi Law Updates' }}</h3>
                <button class="show-more-btn">{{ t('show_more') if t else 'Show More' }} ‚Üê ‚Üí</button>
            </div>
            <div class="updates-cards">
                <div class="update-card">
                    <div class="card-placeholder">{{ t('update_1') if t else 'Latest Legal Update' }}</div>
                </div>
                <div class="update-card">
                    <div class="card-placeholder">{{ t('update_2') if t else 'Regulation Changes' }}</div>
                </div>
                <div class="update-card">
                    <div class="card-placeholder">{{ t('update_3') if t else 'Court Decisions' }}</div>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="quick-actions">
            <div class="action-grid">
                <button class="action-card" onclick="startLegalResearch()">
                    <div class="action-icon">üîç</div>
                    <div class="action-title">{{ t('legal_research') if t else 'Legal Research' }}</div>
                    <div class="action-subtitle">{{ t('search_legal_documents') if t else 'Search legal documents and precedents' }}</div>
                </button>
                <button class="action-card" onclick="analyzeDocument()">
                    <div class="action-icon">üìÑ</div>
                    <div class="action-title">{{ t('document_analysis') if t else 'Document Analysis' }}</div>
                    <div class="action-subtitle">{{ t('analyze_contracts_documents') if t else 'Analyze contracts and documents' }}</div>
                </button>
                <button class="action-card" onclick="viewKnowledgeBase()">
                    <div class="action-icon">üìö</div>
                    <div class="action-title">{{ t('knowledge_base') if t else 'Knowledge Base' }}</div>
                    <div class="action-subtitle">{{ t('manage_your_documents') if t else 'Manage your documents' }}</div>
                </button>
                <button class="action-card" onclick="webResearch()">
                    <div class="action-icon">üåê</div>
                    <div class="action-title">{{ t('web_research') if t else 'Web Research' }}</div>
                    <div class="action-subtitle">{{ t('scrape_legal_websites') if t else 'Scrape legal websites' }}</div>
                </button>
            </div>
        </div>
        
        <!-- Chat Messages Area -->
        <div class="chatgpt-messages" id="chatMessages" style="display: none;">
            <!-- Messages will be dynamically added here -->
        </div>
        
        <!-- Input Area -->
        <div class="chatgpt-input-area">
            <div class="chatgpt-input-container">
                <textarea 
                    class="chatgpt-input" 
                    id="chatInput" 
                    placeholder="{{ t('type_message') if t else 'Type your legal question here...' }}"
                    rows="1"
                    onkeydown="handleKeyDown(event)"
                    oninput="autoResize(this)"
                ></textarea>
                <button class="chatgpt-send-btn" id="sendBtn" onclick="sendMessage()">
                    ‚û§
                </button>
            </div>
        </div>
    </main>
</div>

<script>
// ChatGPT-style functionality
let currentChatId = null;
let isTyping = false;

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('open');
}

function startNewChat() {
    currentChatId = null;
    document.getElementById('welcomeScreen').style.display = 'flex';
    document.getElementById('chatMessages').style.display = 'none';
    document.getElementById('chatInput').value = '';
    document.getElementById('chatInput').focus();
}

function startLegalResearch() {
    window.location.href = '/legal-research';
}

function analyzeDocument() {
    window.location.href = '/document-analysis';
}

function webResearch() {
    window.location.href = '/web-research';
}

function viewKnowledgeBase() {
    window.location.href = '/knowledge-base';
}

function autoResize(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
}

function handleKeyDown(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
    }
}

function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message || isTyping) return;
    
    // Hide welcome screen and show messages
    document.getElementById('welcomeScreen').style.display = 'none';
    document.getElementById('chatMessages').style.display = 'flex';
    
    // Add user message
    addMessage('user', message);
    
    // Clear input
    input.value = '';
    input.style.height = 'auto';
    
    // Show typing indicator
    showTypingIndicator();
    
    // Simulate AI response (replace with actual API call)
    setTimeout(() => {
        hideTypingIndicator();
        addMessage('assistant', 'I understand your legal question. Let me help you with that. This is a simulated response - in the actual implementation, this would connect to your legal research API.');
    }, 2000);
}

function addMessage(sender, text) {
    const messagesContainer = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'chatgpt-message';
    
    const avatar = document.createElement('div');
    avatar.className = `chatgpt-message-avatar ${sender}`;
    avatar.textContent = sender === 'user' ? 'U' : 'AI';
    
    const content = document.createElement('div');
    content.className = 'chatgpt-message-content';
    
    const textDiv = document.createElement('div');
    textDiv.className = 'chatgpt-message-text';
    textDiv.textContent = text;
    
    const metaDiv = document.createElement('div');
    metaDiv.className = 'chatgpt-message-meta';
    metaDiv.textContent = new Date().toLocaleTimeString();
    
    content.appendChild(textDiv);
    content.appendChild(metaDiv);
    
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(content);
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function showTypingIndicator() {
    isTyping = true;
    const messagesContainer = document.getElementById('chatMessages');
    const typingDiv = document.createElement('div');
    typingDiv.className = 'chatgpt-message';
    typingDiv.id = 'typingIndicator';
    
    const avatar = document.createElement('div');
    avatar.className = 'chatgpt-message-avatar assistant';
    avatar.textContent = 'AI';
    
    const content = document.createElement('div');
    content.className = 'chatgpt-message-content';
    
    const typingContent = document.createElement('div');
    typingContent.className = 'chatgpt-typing';
    typingContent.innerHTML = `
        <span>AI is typing</span>
        <div class="chatgpt-typing-dots">
            <div class="chatgpt-typing-dot"></div>
            <div class="chatgpt-typing-dot"></div>
            <div class="chatgpt-typing-dot"></div>
        </div>
    `;
    
    content.appendChild(typingContent);
    
    typingDiv.appendChild(avatar);
    typingDiv.appendChild(content);
    
    messagesContainer.appendChild(typingDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function hideTypingIndicator() {
    isTyping = false;
    const typingIndicator = document.getElementById('typingIndicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

}

// New Dashboard Functions
function performMainSearch() {
    const searchInput = document.getElementById('mainSearchInput');
    const searchFilter = document.querySelector('.search-filter');
    const query = searchInput.value.trim();
    const filter = searchFilter.value;
    
    if (!query) {
        alert('Please enter a search query');
        return;
    }
    
    // Redirect to appropriate page based on filter
    switch(filter) {
        case 'legal_research':
            window.location.href = `/legal-research?query=${encodeURIComponent(query)}`;
            break;
        case 'document_analysis':
            window.location.href = `/document-analysis?query=${encodeURIComponent(query)}`;
            break;
        case 'knowledge_base':
            window.location.href = `/knowledge-base?query=${encodeURIComponent(query)}`;
            break;
        default:
            // Default to legal research
            window.location.href = `/legal-research?query=${encodeURIComponent(query)}`;
    }
}

function filterByCategory(category) {
    // Remove active class from all category buttons
    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Add active class to clicked button
    event.target.closest('.category-btn').classList.add('active');
    
    // You can implement category-specific filtering here
    console.log('Filtering by category:', category);
}

// System Health Check
async function checkSystemHealth() {
    try {
        const response = await fetch('/api/health');
        const health = await response.json();
        
        // Update status indicators
        document.getElementById('ollama-status').className = 
            'status-indicator ' + (health.components.ollama === 'online' ? 'status-online' : 'status-offline');
        
        document.getElementById('database-status').className = 
            'status-indicator ' + (health.components.mysql_database === 'connected' ? 'status-online' : 'status-offline');
        
        document.getElementById('sample-db-status').className = 
            'status-indicator ' + (health.components.sample_database === 'available' ? 'status-online' : 'status-offline');
        
        // Check Firecrawl
        try {
            const firecrawlResponse = await fetch('/api/web-scraping/test-firecrawl');
            const firecrawlStatus = await firecrawlResponse.json();
            
            document.getElementById('firecrawl-status').className = 
                'status-indicator ' + (firecrawlStatus.firecrawl_available ? 'status-online' : 'status-warning');
        } catch (e) {
            document.getElementById('firecrawl-status').className = 'status-indicator status-warning';
        }
        
    } catch (error) {
        console.error('Health check failed:', error);
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('chatInput').focus();
    
    // Load system status
    checkSystemHealth();
    
    // Close sidebar on mobile when clicking outside
    document.addEventListener('click', function(event) {
        const sidebar = document.getElementById('sidebar');
        const mobileMenu = document.querySelector('.chatgpt-mobile-menu');
        
        if (window.innerWidth <= 768 && 
            !sidebar.contains(event.target) && 
            !mobileMenu.contains(event.target)) {
            sidebar.classList.remove('open');
        }
    });
});
</script>
{% endblock %}
