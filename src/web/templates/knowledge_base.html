{% extends "base.html" %}
{% block title %}Knowledge Base - DALI Legal AI{% endblock %}
{% block content %}
<div class="main-header">
    <h1>ðŸ“š Knowledge Base</h1>
    <p>Search and manage your firm's legal knowledge base.</p>
</div>
<form method="post" action="/knowledge-base" style="margin-bottom:2rem;">
    <div style="margin-bottom:1rem;">
        <label for="search_query"><b>Search knowledge base:</b></label><br>
        <input type="text" id="search_query" name="search_query" value="{{ search_query or '' }}" style="width:100%;padding:0.5rem;" placeholder="Enter search terms or legal concepts...">
    </div>
    <div style="display:flex;gap:2rem;margin-bottom:1rem;">
        <div style="flex:1;">
            <label for="num_results"><b>Number of results:</b></label><br>
            <input type="range" id="num_results" name="num_results" min="1" max="20" value="{{ num_results or 5 }}" oninput="this.nextElementSibling.value = this.value">
            <output>{{ num_results or 5 }}</output>
        </div>
        <div style="flex:1;">
            <label for="min_score"><b>Minimum relevance score:</b></label><br>
            <input type="range" id="min_score" name="min_score" min="0" max="1" step="0.01" value="{{ min_score or 0.5 }}" oninput="this.nextElementSibling.value = this.value">
            <output>{{ min_score or 0.5 }}</output>
        </div>
    </div>
    <button type="submit" class="metric-card" style="width:100%;">ðŸ”Ž Search Knowledge Base</button>
</form>
{% if error %}<div class="error-message">{{ error }}</div>{% endif %}
{% if results %}
    <div style="font-weight:bold;font-size:1.1rem;margin-bottom:0.5rem;">Results</div>
    <div style="margin-bottom:1rem;">
        {% for result in results %}
            <details style="margin-bottom:0.5rem;">
                <summary><b>{{ result.metadata.title }}</b> (Score: {{ '%.2f' % result.score }})</summary>
                <div style="padding:0.5rem 1rem;">{{ result.content[:500] }}...</div>
            </details>
        {% endfor %}
    </div>
{% endif %}
<div style="font-weight:bold;font-size:1.1rem;margin-bottom:0.5rem;">Knowledge Base Statistics</div>
<div class="metric-card">ðŸ“„ Total Documents: {{ stats.total_documents }}</div>
<div class="metric-card">ðŸ“‘ Document Types: {{ stats.document_types|length }}</div>
<div class="metric-card">ðŸ”— Sources: {{ stats.sources|length }}</div>
{% if user and stats.total_documents > 0 %}
    <h3>Knowledge Base Documents</h3>
    <table class="metric-table" style="width:100%;margin-bottom:2rem;">
        <thead>
            <tr>
                <th>Title</th>
                <th>Type</th>
                <th>Source</th>
                <th>Uploaded</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
        {% for doc in documents %}
            <tr>
                <td>{{ doc.title }}</td>
                <td>{{ doc.document_type }}</td>
                <td>{{ doc.source }}</td>
                <td>{{ doc.created_at }}</td>
                <td>
                    <button onclick="shareDocument({{ doc.id }})" class="metric-card" style="background:#e3eaf2;color:#1f4e79;border:1px solid #b8c5d1;padding:0.25rem 0.5rem;font-size:0.8rem;">ðŸ“¤ Share</button>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
{% endif %}
{% endblock %}
{% block scripts %}
<script>
function shareDocument(docId) {
    // Get list of users to share with
    fetch('/api/users/all')
        .then(response => response.json())
        .then(data => {
            if (data.users && data.users.length > 0) {
                let userList = 'Select user to share with:\n';
                data.users.forEach((user, index) => {
                    userList += `${index + 1}. ${user.username}\n`;
                });
                
                const userChoice = prompt(userList + '\nEnter user number:');
                const userIndex = parseInt(userChoice) - 1;
                
                if (userIndex >= 0 && userIndex < data.users.length) {
                    const selectedUser = data.users[userIndex];
                    
                    // Share the document
                    fetch('/api/knowledge-base/share', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            doc_id: docId,
                            receiver_id: selectedUser.id
                        })
                    })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            alert(`Document shared successfully with ${selectedUser.username}!`);
                        } else {
                            alert(`Failed to share document: ${result.error}`);
                        }
                    })
                    .catch(error => {
                        console.error('Error sharing document:', error);
                        alert('Error sharing document');
                    });
                } else {
                    alert('Invalid user selection');
                }
            } else {
                alert('No other users found to share with');
            }
        })
        .catch(error => {
            console.error('Error fetching users:', error);
            alert('Error fetching users');
        });
}
</script>
{% endblock %}
