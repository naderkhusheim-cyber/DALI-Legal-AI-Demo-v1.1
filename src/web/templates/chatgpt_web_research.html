{% extends "chatgpt_base.html" %}
{% block title %}{{ t('web_research') if t else 'Web Research' }} - DALI Legal AI{% endblock %}

{% block head %}
<link rel="stylesheet" href="/static/chatgpt-ui.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="chatgpt-layout">
    <!-- ChatGPT-Style Sidebar -->
    <aside class="chatgpt-sidebar" id="sidebar">
        <div class="chatgpt-sidebar-header">
            <div class="chatgpt-sidebar-title">‚öñÔ∏è DALI Legal AI</div>
            <div class="chatgpt-sidebar-subtitle">{{ t('welcome_subtitle') if t else 'Your intelligent legal assistant' }}</div>
        </div>
        
        <button class="chatgpt-new-chat-btn" onclick="startNewResearch()">
            <span>+</span>
            {{ t('new_research') if t else 'New Research' }}
        </button>
        
        <nav class="chatgpt-nav">
            <div class="chatgpt-nav-section">
                <div class="chatgpt-nav-section-title">{{ t('legal_tools') if t else 'Legal Tools' }}</div>
                <div class="chatgpt-nav-item">
                    <a href="/dashboard" class="chatgpt-nav-link">
                        <span class="chatgpt-nav-icon">üè†</span>
                        {{ t('dashboard') if t else 'Dashboard' }}
                    </a>
                </div>
                <div class="chatgpt-nav-item">
                    <a href="/legal-research" class="chatgpt-nav-link">
                        <span class="chatgpt-nav-icon">üîç</span>
                        {{ t('legal_research') if t else 'Legal Research' }}
                    </a>
                </div>
                <div class="chatgpt-nav-item">
                    <a href="/document-analysis" class="chatgpt-nav-link">
                        <span class="chatgpt-nav-icon">üìÑ</span>
                        {{ t('document_analysis') if t else 'Document Analysis' }}
                    </a>
                </div>
                <div class="chatgpt-nav-item">
                    <a href="/knowledge-base" class="chatgpt-nav-link">
                        <span class="chatgpt-nav-icon">üìö</span>
                        {{ t('knowledge_base') if t else 'Knowledge Base' }}
                    </a>
                </div>
                <div class="chatgpt-nav-item">
                    <a href="/web-research" class="chatgpt-nav-link active">
                        <span class="chatgpt-nav-icon">üåê</span>
                        {{ t('web_research') if t else 'Web Research' }}
                    </a>
                </div>
            </div>
            
            <div class="chatgpt-nav-section">
                <div class="chatgpt-nav-section-title">{{ t('account') if t else 'Account' }}</div>
                <div class="chatgpt-nav-item">
                    <a href="/settings" class="chatgpt-nav-link">
                        <span class="chatgpt-nav-icon">‚öôÔ∏è</span>
                        {{ t('settings') if t else 'Settings' }}
                    </a>
                </div>
                {% if user and user.role == 'admin' %}
                <div class="chatgpt-nav-item">
                    <a href="/admin/dashboard" class="chatgpt-nav-link">
                        <span class="chatgpt-nav-icon">üëë</span>
                        {{ t('admin_panel') if t else 'Admin Panel' }}
                    </a>
                </div>
                {% endif %}
            </div>
        </nav>
        
        {% if user %}
        <div class="chatgpt-user-info">
            <div class="chatgpt-user-greeting">{{ t('hello') if t else 'Hello' }}, {{ user.greeting_name or user.username }}</div>
            <div class="chatgpt-user-role">{{ t('role_' + user.role) if t else user.role.title() }}</div>
            <form method="get" action="/logout">
                <button type="submit" class="chatgpt-logout-btn">
                    {{ t('logout') if t else 'Logout' }}
                </button>
            </form>
        </div>
        {% endif %}
    </aside>
    
    <!-- Main Web Research Interface -->
    <main class="chatgpt-main">
        <!-- Mobile Menu Button -->
        <button class="chatgpt-mobile-menu" onclick="toggleSidebar()">
            ‚ò∞
        </button>
        
        <!-- Web Research Header -->
        <div class="chatgpt-header">
            <div class="chatgpt-header-title">{{ t('web_research') if t else 'Web Research' }}</div>
            <div class="chatgpt-header-subtitle">{{ t('web_research_subtitle') if t else 'Scrape and analyze web content for legal research' }}</div>
        </div>
        
        <!-- Welcome Screen -->
        <div class="chatgpt-welcome" id="welcomeScreen">
            <div class="chatgpt-welcome-icon">üåê</div>
            <h1 class="chatgpt-welcome-title">{{ t('web_research') if t else 'Web Research' }}</h1>
            <p class="chatgpt-welcome-subtitle">{{ t('web_research_description') if t else 'Scrape websites, extract legal information, and add content to your knowledge base for comprehensive legal research.' }}</p>
            
            <div class="chatgpt-welcome-actions">
                <button class="chatgpt-action-btn" onclick="scrapeWebsite()">
                    üï∑Ô∏è {{ t('scrape_website') if t else 'Scrape Website' }}
                </button>
                <button class="chatgpt-action-btn" onclick="researchLegalSites()">
                    ‚öñÔ∏è {{ t('research_legal_sites') if t else 'Research Legal Sites' }}
                </button>
                <button class="chatgpt-action-btn" onclick="extractContent()">
                    üìÑ {{ t('extract_content') if t else 'Extract Content' }}
                </button>
                <button class="chatgpt-action-btn" onclick="addToKnowledgeBase()">
                    üìö {{ t('add_to_knowledge_base') if t else 'Add to Knowledge Base' }}
                </button>
            </div>
        </div>
        
        <!-- Research Interface -->
        <div class="chatgpt-messages" id="researchInterface" style="display: none;">
            <div class="chatgpt-card">
                <div class="chatgpt-card-header">
                    <div class="chatgpt-card-title">{{ t('web_research') if t else 'Web Research' }}</div>
                    <div class="chatgpt-card-subtitle">{{ t('enter_url_to_research') if t else 'Enter a URL to research and scrape content' }}</div>
                </div>
                
                <form id="webResearchForm">
                    <div class="chatgpt-form-group">
                        <label class="chatgpt-form-label">{{ t('website_url') if t else 'Website URL' }}</label>
                        <input type="url" class="chatgpt-form-input" id="websiteUrl" placeholder="https://example.com" required>
                    </div>
                    
                    <div class="chatgpt-form-group">
                        <label class="chatgpt-form-label">{{ t('research_type') if t else 'Research Type' }}</label>
                        <select class="chatgpt-form-input" id="researchType">
                            <option value="scrape">{{ t('scrape_content') if t else 'Scrape Content' }}</option>
                            <option value="analyze">{{ t('analyze_content') if t else 'Analyze Content' }}</option>
                            <option value="extract">{{ t('extract_key_points') if t else 'Extract Key Points' }}</option>
                            <option value="summarize">{{ t('summarize_content') if t else 'Summarize Content' }}</option>
                        </select>
                    </div>
                    
                    <div class="chatgpt-form-group">
                        <label class="chatgpt-form-label">
                            <input type="checkbox" id="addToKb" checked>
                            {{ t('add_to_knowledge_base') if t else 'Add to Knowledge Base' }}
                        </label>
                    </div>
                    
                    <button type="submit" class="chatgpt-btn chatgpt-btn-primary" style="width: 100%;">
                        üåê {{ t('start_research') if t else 'Start Research' }}
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Research Results -->
        <div class="chatgpt-messages" id="researchResults" style="display: none;">
            <!-- Research results will be displayed here -->
        </div>
        
        <!-- Input Area -->
        <div class="chatgpt-input-area">
            <div class="chatgpt-input-container">
                <textarea 
                    class="chatgpt-input" 
                    id="chatInput" 
                    placeholder="{{ t('ask_about_web_research') if t else 'Ask questions about web research or enter URLs...' }}"
                    rows="1"
                    onkeydown="handleKeyDown(event)"
                    oninput="autoResize(this)"
                ></textarea>
                <button class="chatgpt-send-btn" id="sendBtn" onclick="sendMessage()">
                    ‚û§
                </button>
            </div>
        </div>
    </main>
</div>

<script>
let currentResearchId = null;
let isResearching = false;

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('open');
}

function startNewResearch() {
    currentResearchId = null;
    document.getElementById('welcomeScreen').style.display = 'flex';
    document.getElementById('researchInterface').style.display = 'none';
    document.getElementById('researchResults').style.display = 'none';
    document.getElementById('chatInput').value = '';
}

function scrapeWebsite() {
    document.getElementById('researchType').value = 'scrape';
    showResearchInterface();
}

function researchLegalSites() {
    document.getElementById('researchType').value = 'analyze';
    showResearchInterface();
}

function extractContent() {
    document.getElementById('researchType').value = 'extract';
    showResearchInterface();
}

function addToKnowledgeBase() {
    document.getElementById('researchType').value = 'scrape';
    document.getElementById('addToKb').checked = true;
    showResearchInterface();
}

function showResearchInterface() {
    document.getElementById('welcomeScreen').style.display = 'none';
    document.getElementById('researchInterface').style.display = 'flex';
    document.getElementById('researchResults').style.display = 'none';
}

function autoResize(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
}

function handleKeyDown(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
    }
}

function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message || isResearching) return;
    
    // Check if it's a URL
    if (message.startsWith('http://') || message.startsWith('https://')) {
        document.getElementById('websiteUrl').value = message;
        document.getElementById('researchType').value = 'scrape';
        document.getElementById('addToKb').checked = true;
        showResearchInterface();
        return;
    }
    
    // Add user message
    addMessage('user', message);
    
    // Clear input
    input.value = '';
    input.style.height = 'auto';
    
    // Show typing indicator
    showTypingIndicator();
    
    // Simulate AI response (replace with actual API call)
    setTimeout(() => {
        hideTypingIndicator();
        addMessage('assistant', 'I understand your web research question. This is a simulated response - in the actual implementation, this would help you with web research and content extraction.');
    }, 2000);
}

function formatMessage(text) {
    // Convert the text to HTML with proper formatting
    let formatted = text
        // Convert numbered lists (1. **text**: description)
        .replace(/(\d+)\.\s*\*\*(.*?)\*\*:\s*(.*?)(?=\d+\.\s*\*\*|$)/gs, (match, num, title, desc) => {
            return `<div class="chatgpt-list-item">
                <div class="chatgpt-list-number">${num}.</div>
                <div class="chatgpt-list-content">
                    <div class="chatgpt-list-title">${title}</div>
                    <div class="chatgpt-list-description">${desc.trim()}</div>
                </div>
            </div>`;
        })
        // Convert bold text **text** to <strong>text</strong>
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        // Convert line breaks to <br>
        .replace(/\n/g, '<br>')
        // Convert double line breaks to paragraph breaks
        .replace(/(<br>\s*){2,}/g, '</p><p>')
        // Wrap in paragraph tags
        .replace(/^(.*)$/, '<p>$1</p>')
        // Clean up empty paragraphs
        .replace(/<p><\/p>/g, '')
        .replace(/<p><br><\/p>/g, '');
    
    return formatted;
}

function addMessage(sender, text) {
    const messagesContainer = document.getElementById('researchResults');
    if (messagesContainer.style.display === 'none') {
        messagesContainer.style.display = 'flex';
        document.getElementById('welcomeScreen').style.display = 'none';
        document.getElementById('researchInterface').style.display = 'none';
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'chatgpt-message';
    
    const avatar = document.createElement('div');
    avatar.className = `chatgpt-message-avatar ${sender}`;
    avatar.textContent = sender === 'user' ? 'U' : 'AI';
    
    const content = document.createElement('div');
    content.className = 'chatgpt-message-content';
    
    const textDiv = document.createElement('div');
    textDiv.className = 'chatgpt-message-text';
    
    if (sender === 'assistant') {
        // Format AI responses with proper HTML
        textDiv.innerHTML = formatMessage(text);
    } else {
        // Keep user messages as plain text
        textDiv.textContent = text;
    }
    
    const metaDiv = document.createElement('div');
    metaDiv.className = 'chatgpt-message-meta';
    metaDiv.textContent = new Date().toLocaleTimeString();
    
    content.appendChild(textDiv);
    content.appendChild(metaDiv);
    
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(content);
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function showTypingIndicator() {
    isResearching = true;
    const messagesContainer = document.getElementById('researchResults');
    if (messagesContainer.style.display === 'none') {
        messagesContainer.style.display = 'flex';
        document.getElementById('welcomeScreen').style.display = 'none';
        document.getElementById('researchInterface').style.display = 'none';
    }
    
    const typingDiv = document.createElement('div');
    typingDiv.className = 'chatgpt-message';
    typingDiv.id = 'typingIndicator';
    
    const avatar = document.createElement('div');
    avatar.className = 'chatgpt-message-avatar assistant';
    avatar.textContent = 'AI';
    
    const content = document.createElement('div');
    content.className = 'chatgpt-message-content';
    
    const typingContent = document.createElement('div');
    typingContent.className = 'chatgpt-typing';
    typingContent.innerHTML = `
        <span>AI is researching...</span>
        <div class="chatgpt-typing-dots">
            <div class="chatgpt-typing-dot"></div>
            <div class="chatgpt-typing-dot"></div>
            <div class="chatgpt-typing-dot"></div>
        </div>
    `;
    
    content.appendChild(typingContent);
    
    typingDiv.appendChild(avatar);
    typingDiv.appendChild(content);
    
    messagesContainer.appendChild(typingDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function hideTypingIndicator() {
    isResearching = false;
    const typingIndicator = document.getElementById('typingIndicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

// Web research form handling
document.getElementById('webResearchForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const websiteUrl = document.getElementById('websiteUrl').value;
    const researchType = document.getElementById('researchType').value;
    const addToKb = document.getElementById('addToKb').checked;
    
    if (!websiteUrl.trim()) {
        alert('Please enter a website URL.');
        return;
    }
    
    const formData = new FormData();
    formData.append('research_urls', websiteUrl);
    formData.append('max_pages', '1');
    if (addToKb) {
        formData.append('add_to_kb', 'on');
    }
    
    // Show researching indicator
    showTypingIndicator();
    
    fetch('/web-research', {
        method: 'POST',
        body: formData
    })
    .then(response => response.text())
    .then(html => {
        hideTypingIndicator();
        // Extract the research results from the response
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        let result = 'Website scraped and analyzed successfully!';
        
        // Look for web research results in various possible locations
        const resultSelectors = [
            '.web-research-result',
            '.web-research-results',
            '.research-results',
            '.results',
            '.content',
            'table',
            '.response'
        ];
        
        for (const selector of resultSelectors) {
            const element = doc.querySelector(selector);
            if (element && element.textContent.trim()) {
                const text = element.textContent.trim();
                if (text.length > 50) {
                    result = text;
                    break;
                }
            }
        }
        
        // If no specific results found, look for any meaningful content
        if (result === 'Website scraped and analyzed successfully!') {
            const bodyText = doc.body.textContent.trim();
            if (bodyText && bodyText.length > 50) {
                // Extract meaningful content (skip navigation, headers, etc.)
                const lines = bodyText.split('\n').filter(line => 
                    line.trim().length > 20 && 
                    !line.includes('DALI') && 
                    !line.includes('Navigation') &&
                    !line.includes('Settings') &&
                    !line.includes('Web Research')
                );
                if (lines.length > 0) {
                    result = lines.slice(0, 5).join('\n').trim(); // Take first 5 meaningful lines
                }
            }
        }
        
        document.getElementById('researchInterface').style.display = 'none';
        document.getElementById('researchResults').style.display = 'flex';
        addMessage('assistant', result);
    })
    .catch(error => {
        hideTypingIndicator();
        alert('Error researching website. Please try again.');
        console.error('Error:', error);
    });
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('chatInput').focus();
    
    // Close sidebar on mobile when clicking outside
    document.addEventListener('click', function(event) {
        const sidebar = document.getElementById('sidebar');
        const mobileMenu = document.querySelector('.chatgpt-mobile-menu');
        
        if (window.innerWidth <= 768 && 
            !sidebar.contains(event.target) && 
            !mobileMenu.contains(event.target)) {
            sidebar.classList.remove('open');
        }
    });
});
</script>
{% endblock %}
